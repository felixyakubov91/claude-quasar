# Task 7.2: SEO Optimization

## Goal
Implement comprehensive SEO with meta tags, structured data, and sitemap.

## Instructions

### Create SEO Composable
Create `frontend/src/composables/useSeo.ts`:

```typescript
import { computed } from 'vue';
import { useMeta } from 'quasar';
import { useI18n } from 'vue-i18n';
import { useRoute } from 'vue-router';
import { env } from 'src/utils/env';

interface SeoOptions {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'product' | 'article';
  canonicalUrl?: string;
  noIndex?: boolean;
  structuredData?: object;
}

export function useSeo(options: SeoOptions = {}) {
  const { locale } = useI18n();
  const route = useRoute();

  const siteUrl = env.siteUrl || 'https://example.com';

  const meta = computed(() => {
    const title = options.title
      ? `${options.title} | ${env.siteName}`
      : env.siteName;

    const description = options.description || env.siteDescription;
    const image = options.image || `${siteUrl}/images/og-default.jpg`;
    const canonicalUrl = options.canonicalUrl || `${siteUrl}${route.fullPath}`;

    const metaTags: Record<string, any> = {
      title,
      titleTemplate: (title: string) => title,

      meta: {
        description: { name: 'description', content: description },
        keywords: { name: 'keywords', content: env.siteKeywords },

        // Open Graph
        ogTitle: { property: 'og:title', content: title },
        ogDescription: { property: 'og:description', content: description },
        ogImage: { property: 'og:image', content: image },
        ogUrl: { property: 'og:url', content: canonicalUrl },
        ogType: { property: 'og:type', content: options.type || 'website' },
        ogSiteName: { property: 'og:site_name', content: env.siteName },
        ogLocale: { property: 'og:locale', content: locale.value === 'he' ? 'he_IL' : 'en_US' },

        // Twitter
        twitterCard: { name: 'twitter:card', content: 'summary_large_image' },
        twitterTitle: { name: 'twitter:title', content: title },
        twitterDescription: { name: 'twitter:description', content: description },
        twitterImage: { name: 'twitter:image', content: image },
      },

      link: {
        canonical: { rel: 'canonical', href: canonicalUrl },
      },
    };

    // Add alternate language links
    if (locale.value === 'he') {
      metaTags.link.alternate_en = {
        rel: 'alternate',
        hreflang: 'en',
        href: canonicalUrl.replace('/he/', '/en/'),
      };
    } else {
      metaTags.link.alternate_he = {
        rel: 'alternate',
        hreflang: 'he',
        href: canonicalUrl.replace('/en/', '/he/'),
      };
    }

    // No index if specified
    if (options.noIndex) {
      metaTags.meta.robots = { name: 'robots', content: 'noindex, nofollow' };
    }

    // Add structured data
    if (options.structuredData) {
      metaTags.script = {
        ldJson: {
          type: 'application/ld+json',
          innerHTML: JSON.stringify(options.structuredData),
        },
      };
    }

    return metaTags;
  });

  useMeta(meta);
}

// Helper for product structured data
export function getProductStructuredData(product: any, locale: string) {
  const name = locale === 'he'
    ? product.attributes.name_he || product.attributes.name_en
    : product.attributes.name_en;

  const description = locale === 'he'
    ? product.attributes.short_description_he || product.attributes.short_description_en
    : product.attributes.short_description_en;

  return {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name,
    description,
    image: product.attributes.images?.data?.map((img: any) => img.attributes.url) || [],
    sku: product.attributes.slug,
    offers: {
      '@type': 'Offer',
      price: product.attributes.sale_price || product.attributes.base_price,
      priceCurrency: 'ILS',
      availability: product.attributes.is_active
        ? 'https://schema.org/InStock'
        : 'https://schema.org/OutOfStock',
    },
    aggregateRating: product.attributes.reviews?.data?.length
      ? {
          '@type': 'AggregateRating',
          ratingValue: calculateAverageRating(product.attributes.reviews.data),
          reviewCount: product.attributes.reviews.data.length,
        }
      : undefined,
  };
}

function calculateAverageRating(reviews: any[]): number {
  if (!reviews.length) return 0;
  const sum = reviews.reduce((acc, r) => acc + r.attributes.rating, 0);
  return Math.round((sum / reviews.length) * 10) / 10;
}

// Helper for organization structured data
export function getOrganizationStructuredData() {
  return {
    '@context': 'https://schema.org',
    '@type': 'Organization',
    name: env.siteName,
    url: env.siteUrl,
    logo: `${env.siteUrl}/images/logo.png`,
    contactPoint: {
      '@type': 'ContactPoint',
      telephone: env.contactPhone,
      contactType: 'customer service',
      availableLanguage: ['Hebrew', 'English'],
    },
    sameAs: [
      env.facebookUrl,
      env.instagramUrl,
    ].filter(Boolean),
  };
}

// Helper for breadcrumb structured data
export function getBreadcrumbStructuredData(items: Array<{ name: string; url: string }>) {
  return {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: items.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: item.name,
      item: item.url,
    })),
  };
}
```

### Create Sitemap Generator
Create `frontend/src-ssr/middlewares/sitemap.ts`:

```typescript
import { ssrMiddleware } from 'quasar/wrappers';
import axios from 'axios';

const strapiUrl = process.env.STRAPI_URL || 'http://localhost:1337';

export default ssrMiddleware(async ({ app }) => {
  app.get('/sitemap.xml', async (req, res) => {
    try {
      const [products, categories] = await Promise.all([
        axios.get(`${strapiUrl}/api/products?filters[is_active][$eq]=true&pagination[pageSize]=1000`),
        axios.get(`${strapiUrl}/api/categories?filters[is_active][$eq]=true`),
      ]);

      const siteUrl = process.env.SITE_URL || 'https://example.com';
      const now = new Date().toISOString();

      let xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xhtml="http://www.w3.org/1999/xhtml">
  <!-- Static pages -->
  <url>
    <loc>${siteUrl}</loc>
    <lastmod>${now}</lastmod>
    <changefreq>daily</changefreq>
    <priority>1.0</priority>
    <xhtml:link rel="alternate" hreflang="en" href="${siteUrl}/en" />
    <xhtml:link rel="alternate" hreflang="he" href="${siteUrl}/he" />
  </url>
  <url>
    <loc>${siteUrl}/products</loc>
    <lastmod>${now}</lastmod>
    <changefreq>daily</changefreq>
    <priority>0.9</priority>
  </url>
`;

      // Category pages
      for (const category of categories.data.data) {
        xml += `  <url>
    <loc>${siteUrl}/category/${category.attributes.slug}</loc>
    <lastmod>${category.attributes.updatedAt}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
`;
      }

      // Product pages
      for (const product of products.data.data) {
        xml += `  <url>
    <loc>${siteUrl}/products/${product.attributes.slug}</loc>
    <lastmod>${product.attributes.updatedAt}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.7</priority>
  </url>
`;
      }

      xml += '</urlset>';

      res.set('Content-Type', 'application/xml');
      res.send(xml);
    } catch (error) {
      console.error('Sitemap generation error:', error);
      res.status(500).send('Error generating sitemap');
    }
  });
});
```

### Create robots.txt Handler
Create `frontend/src-ssr/middlewares/robots.ts`:

```typescript
import { ssrMiddleware } from 'quasar/wrappers';

export default ssrMiddleware(({ app }) => {
  app.get('/robots.txt', (req, res) => {
    const siteUrl = process.env.SITE_URL || 'https://example.com';

    const robots = `User-agent: *
Allow: /

Disallow: /profile/
Disallow: /checkout/
Disallow: /cart/
Disallow: /auth/

Sitemap: ${siteUrl}/sitemap.xml
`;

    res.set('Content-Type', 'text/plain');
    res.send(robots);
  });
});
```

### Create SeoHead Component
Create `frontend/src/components/common/SeoHead.vue`:

```vue
<template>
  <teleport to="head">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://res.cloudinary.com" />
  </teleport>
</template>

<script setup lang="ts">
import { onMounted } from 'vue';

// Preload critical fonts
onMounted(() => {
  const link = document.createElement('link');
  link.rel = 'preload';
  link.as = 'font';
  link.href = '/fonts/rubik-hebrew.woff2';
  link.type = 'font/woff2';
  link.crossOrigin = 'anonymous';
  document.head.appendChild(link);
});
</script>
```

### Update Product Page for SEO
Update `frontend/src/pages/products/[slug].vue` to include SEO:

```vue
<script setup lang="ts">
import { useSeo, getProductStructuredData, getBreadcrumbStructuredData } from 'src/composables/useSeo';

// ... existing code ...

watch(product, (p) => {
  if (!p) return;

  const name = locale.value === 'he'
    ? p.attributes.name_he || p.attributes.name_en
    : p.attributes.name_en;

  const description = locale.value === 'he'
    ? p.attributes.short_description_he || p.attributes.short_description_en
    : p.attributes.short_description_en;

  const structuredData = {
    '@context': 'https://schema.org',
    '@graph': [
      getProductStructuredData(p, locale.value),
      getBreadcrumbStructuredData([
        { name: t('nav.home'), url: env.siteUrl },
        { name: t('nav.products'), url: `${env.siteUrl}/products` },
        { name, url: `${env.siteUrl}/products/${p.attributes.slug}` },
      ]),
    ],
  };

  useSeo({
    title: p.attributes.meta_title || name,
    description: p.attributes.meta_description || description,
    image: p.attributes.images?.data?.[0]?.attributes?.url,
    type: 'product',
    structuredData,
  });
}, { immediate: true });
</script>
```

### Add Environment Variables
Update `frontend/src/utils/env.ts`:

```typescript
export const env = {
  // ... existing ...
  siteName: import.meta.env.VITE_SITE_NAME || 'Print Shop',
  siteDescription: import.meta.env.VITE_SITE_DESCRIPTION || '',
  siteKeywords: import.meta.env.VITE_SITE_KEYWORDS || '',
  siteUrl: import.meta.env.VITE_SITE_URL || 'https://example.com',
  contactPhone: import.meta.env.VITE_CONTACT_PHONE || '',
  facebookUrl: import.meta.env.VITE_FACEBOOK_URL || '',
  instagramUrl: import.meta.env.VITE_INSTAGRAM_URL || '',
};
```

## Acceptance Criteria
- [ ] Meta tags render correctly
- [ ] Open Graph tags work
- [ ] Structured data validates
- [ ] Sitemap generates dynamically
- [ ] robots.txt configured
- [ ] Canonical URLs correct
- [ ] Language alternates set
