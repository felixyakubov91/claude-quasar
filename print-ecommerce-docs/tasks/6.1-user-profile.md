# Task 6.1: User Profile

## Goal
Build user profile page with account management.

## Instructions

### Create Profile Page
Create `frontend/src/pages/profile/IndexPage.vue`:

```vue
<template>
  <q-page class="q-pa-md">
    <div class="row justify-center">
      <div class="col-12 col-md-8">
        <h1 class="text-h4 q-mb-lg">{{ $t('profile.myAccount') }}</h1>

        <q-card class="q-mb-md">
          <q-card-section>
            <div class="text-h6">{{ $t('profile.personalInfo') }}</div>
          </q-card-section>
          <q-separator />
          <q-card-section>
            <q-form @submit.prevent="updateProfile">
              <div class="row q-col-gutter-md">
                <div class="col-12 col-sm-6">
                  <q-input
                    v-model="form.full_name"
                    :label="$t('profile.fullName')"
                    outlined
                    :rules="[required]"
                  />
                </div>
                <div class="col-12 col-sm-6">
                  <q-input
                    v-model="form.phone"
                    :label="$t('profile.phone')"
                    outlined
                  />
                </div>
                <div class="col-12">
                  <q-input
                    v-model="form.email"
                    :label="$t('profile.email')"
                    outlined
                    disable
                  />
                </div>
                <div class="col-12 col-sm-6">
                  <q-select
                    v-model="form.preferred_language"
                    :label="$t('profile.language')"
                    :options="languageOptions"
                    outlined
                    emit-value
                    map-options
                  />
                </div>
              </div>
              <q-btn
                type="submit"
                color="primary"
                :label="$t('common.save')"
                :loading="saving"
                class="q-mt-md"
              />
            </q-form>
          </q-card-section>
        </q-card>

        <q-card class="q-mb-md">
          <q-card-section>
            <div class="text-h6">{{ $t('profile.addresses') }}</div>
          </q-card-section>
          <q-separator />
          <q-card-section>
            <AddressList
              :addresses="customer?.addresses || []"
              @add="showAddressDialog = true"
              @edit="editAddress"
              @delete="deleteAddress"
              @set-default="setDefaultAddress"
            />
          </q-card-section>
        </q-card>

        <q-card>
          <q-card-section>
            <div class="text-h6">{{ $t('profile.security') }}</div>
          </q-card-section>
          <q-separator />
          <q-card-section>
            <q-btn
              outline
              color="primary"
              :label="$t('profile.changePassword')"
              @click="showPasswordDialog = true"
            />
          </q-card-section>
        </q-card>
      </div>
    </div>

    <AddressDialog
      v-model="showAddressDialog"
      :address="editingAddress"
      @save="saveAddress"
    />

    <PasswordDialog
      v-model="showPasswordDialog"
      @save="changePassword"
    />
  </q-page>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue';
import { useQuasar } from 'quasar';
import { useI18n } from 'vue-i18n';
import { useAuth } from 'src/composables/useAuth';
import { strapiService } from 'src/services/strapi.service';
import AddressList from 'src/components/profile/AddressList.vue';
import AddressDialog from 'src/components/profile/AddressDialog.vue';
import PasswordDialog from 'src/components/profile/PasswordDialog.vue';

const $q = useQuasar();
const { t } = useI18n();
const { user, session, updatePassword } = useAuth();

const customer = ref<any>(null);
const saving = ref(false);
const showAddressDialog = ref(false);
const showPasswordDialog = ref(false);
const editingAddress = ref<any>(null);

const form = reactive({
  full_name: '',
  phone: '',
  email: '',
  preferred_language: 'he',
});

const languageOptions = [
  { label: 'עברית', value: 'he' },
  { label: 'English', value: 'en-US' },
];

const required = (v: string) => !!v || t('validation.required');

const loadCustomer = async () => {
  if (!user.value) return;
  const response = await strapiService.getCustomerBySupabaseId(
    user.value.id,
    session.value?.access_token
  );
  customer.value = response.data?.[0]?.attributes;

  form.full_name = customer.value?.full_name || '';
  form.phone = customer.value?.phone || '';
  form.email = user.value.email || '';
  form.preferred_language = customer.value?.preferred_language || 'he';
};

const updateProfile = async () => {
  saving.value = true;
  try {
    await strapiService.updateCustomer(customer.value.id, {
      full_name: form.full_name,
      phone: form.phone,
      preferred_language: form.preferred_language,
    }, session.value?.access_token);

    $q.notify({ type: 'positive', message: t('profile.updated') });
  } catch (error) {
    $q.notify({ type: 'negative', message: t('common.error') });
  } finally {
    saving.value = false;
  }
};

const editAddress = (address: any) => {
  editingAddress.value = address;
  showAddressDialog.value = true;
};

const saveAddress = async (address: any) => {
  const addresses = [...(customer.value.addresses || [])];

  if (editingAddress.value) {
    const index = addresses.findIndex((a: any) => a.id === editingAddress.value.id);
    addresses[index] = address;
  } else {
    addresses.push({ ...address, id: Date.now() });
  }

  await strapiService.updateCustomer(customer.value.id, { addresses }, session.value?.access_token);
  await loadCustomer();
  showAddressDialog.value = false;
  editingAddress.value = null;
};

const deleteAddress = async (addressId: number) => {
  const addresses = customer.value.addresses.filter((a: any) => a.id !== addressId);
  await strapiService.updateCustomer(customer.value.id, { addresses }, session.value?.access_token);
  await loadCustomer();
};

const setDefaultAddress = async (addressId: number) => {
  const addresses = customer.value.addresses.map((a: any) => ({
    ...a,
    is_default: a.id === addressId,
  }));
  await strapiService.updateCustomer(customer.value.id, { addresses }, session.value?.access_token);
  await loadCustomer();
};

const changePassword = async (newPassword: string) => {
  try {
    await updatePassword(newPassword);
    $q.notify({ type: 'positive', message: t('profile.passwordChanged') });
    showPasswordDialog.value = false;
  } catch (error) {
    $q.notify({ type: 'negative', message: t('common.error') });
  }
};

onMounted(loadCustomer);
</script>
```

### Create AddressList Component
Create `frontend/src/components/profile/AddressList.vue`:

```vue
<template>
  <div>
    <q-list separator v-if="addresses.length">
      <q-item v-for="address in addresses" :key="address.id">
        <q-item-section>
          <q-item-label>
            {{ address.label }}
            <q-badge v-if="address.is_default" color="primary" class="q-ml-sm">
              {{ $t('profile.default') }}
            </q-badge>
          </q-item-label>
          <q-item-label caption>
            {{ address.full_name }}<br>
            {{ address.street_address }}<br>
            {{ address.city }}, {{ address.postal_code }}
          </q-item-label>
        </q-item-section>
        <q-item-section side>
          <div class="row q-gutter-xs">
            <q-btn flat dense icon="edit" @click="$emit('edit', address)" />
            <q-btn flat dense icon="delete" color="negative" @click="$emit('delete', address.id)" />
            <q-btn
              v-if="!address.is_default"
              flat
              dense
              icon="star_outline"
              @click="$emit('set-default', address.id)"
            />
          </div>
        </q-item-section>
      </q-item>
    </q-list>

    <div v-else class="text-grey-6 q-pa-md text-center">
      {{ $t('profile.noAddresses') }}
    </div>

    <q-btn
      outline
      color="primary"
      icon="add"
      :label="$t('profile.addAddress')"
      class="q-mt-md"
      @click="$emit('add')"
    />
  </div>
</template>

<script setup lang="ts">
defineProps<{ addresses: any[] }>();
defineEmits(['add', 'edit', 'delete', 'set-default']);
</script>
```

### Create AddressDialog Component
Create `frontend/src/components/profile/AddressDialog.vue`:

```vue
<template>
  <q-dialog :model-value="modelValue" @update:model-value="$emit('update:modelValue', $event)">
    <q-card style="min-width: 400px">
      <q-card-section>
        <div class="text-h6">{{ address ? $t('profile.editAddress') : $t('profile.addAddress') }}</div>
      </q-card-section>

      <q-card-section>
        <q-form @submit.prevent="save">
          <q-input v-model="form.label" :label="$t('profile.addressLabel')" outlined class="q-mb-sm" />
          <q-input v-model="form.full_name" :label="$t('checkout.fullName')" outlined class="q-mb-sm" :rules="[required]" />
          <q-input v-model="form.phone" :label="$t('checkout.phone')" outlined class="q-mb-sm" />
          <q-input v-model="form.street_address" :label="$t('checkout.address')" outlined class="q-mb-sm" :rules="[required]" />
          <q-input v-model="form.city" :label="$t('checkout.city')" outlined class="q-mb-sm" :rules="[required]" />
          <q-input v-model="form.postal_code" :label="$t('checkout.postalCode')" outlined class="q-mb-sm" />
        </q-form>
      </q-card-section>

      <q-card-actions align="right">
        <q-btn flat :label="$t('common.cancel')" v-close-popup />
        <q-btn color="primary" :label="$t('common.save')" @click="save" />
      </q-card-actions>
    </q-card>
  </q-dialog>
</template>

<script setup lang="ts">
import { reactive, watch } from 'vue';
import { useI18n } from 'vue-i18n';

const props = defineProps<{ modelValue: boolean; address?: any }>();
const emit = defineEmits(['update:modelValue', 'save']);
const { t } = useI18n();

const form = reactive({
  label: '',
  full_name: '',
  phone: '',
  street_address: '',
  city: '',
  postal_code: '',
  country: 'Israel',
});

const required = (v: string) => !!v || t('validation.required');

watch(() => props.address, (addr) => {
  if (addr) {
    Object.assign(form, addr);
  } else {
    Object.assign(form, {
      label: '',
      full_name: '',
      phone: '',
      street_address: '',
      city: '',
      postal_code: '',
      country: 'Israel',
    });
  }
}, { immediate: true });

const save = () => {
  emit('save', { ...form, id: props.address?.id });
};
</script>
```

## Acceptance Criteria
- [ ] Profile info editable
- [ ] Addresses manageable
- [ ] Language preference saves
- [ ] Password change works
