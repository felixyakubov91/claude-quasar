# Task 1.5: Environment Variables Setup

## Goal
Set up comprehensive environment variable configuration for both frontend and backend with proper documentation.

## Prerequisites
- Tasks 1.1-1.4 completed
- All external service accounts created (Supabase, Cloudinary, etc.)

## Instructions

### Step 1: Frontend Environment Variables

Create `frontend/.env.example`:

```env
# =============================================================================
# PRINT E-COMMERCE FRONTEND CONFIGURATION
# =============================================================================

# -----------------------------------------------------------------------------
# API Endpoints
# -----------------------------------------------------------------------------
# Strapi backend URL (no trailing slash)
VITE_STRAPI_URL=http://localhost:1337

# Strapi API Token (generate in Strapi Admin → Settings → API Tokens)
VITE_STRAPI_API_TOKEN=

# -----------------------------------------------------------------------------
# Supabase Authentication
# -----------------------------------------------------------------------------
# Project URL from Supabase Dashboard → Settings → API
VITE_SUPABASE_URL=https://your-project.supabase.co

# Anon/Public key from Supabase Dashboard → Settings → API
VITE_SUPABASE_ANON_KEY=

# -----------------------------------------------------------------------------
# Cloudinary Image Processing
# -----------------------------------------------------------------------------
# Cloud name from Cloudinary Dashboard
VITE_CLOUDINARY_CLOUD_NAME=

# Upload preset name (create in Cloudinary Settings → Upload)
VITE_CLOUDINARY_UPLOAD_PRESET=

# API Key (for signed uploads, optional if using unsigned)
VITE_CLOUDINARY_API_KEY=

# -----------------------------------------------------------------------------
# PayPlus Payment
# -----------------------------------------------------------------------------
# PayPlus API credentials
VITE_PAYPLUS_API_KEY=
VITE_PAYPLUS_SECRET_KEY=
VITE_PAYPLUS_PAGE_UID=

# Payment mode: sandbox or live
VITE_PAYPLUS_MODE=sandbox

# -----------------------------------------------------------------------------
# Google Analytics
# -----------------------------------------------------------------------------
# GA4 Measurement ID (G-XXXXXXXXXX)
VITE_GA_MEASUREMENT_ID=

# -----------------------------------------------------------------------------
# Application Settings
# -----------------------------------------------------------------------------
# Default locale (en-US or he)
VITE_DEFAULT_LOCALE=he

# Company/Brand name
VITE_COMPANY_NAME=Print Company

# Currency code
VITE_CURRENCY_CODE=ILS

# Currency symbol
VITE_CURRENCY_SYMBOL=₪

# -----------------------------------------------------------------------------
# Feature Flags
# -----------------------------------------------------------------------------
# Enable/disable features
VITE_ENABLE_REVIEWS=true
VITE_ENABLE_WISHLIST=false
VITE_ENABLE_LIVE_CHAT=false
```

Create `frontend/.env` by copying from example:

```bash
cp frontend/.env.example frontend/.env
# Then fill in actual values
```

### Step 2: Backend Environment Variables

Create `backend/.env.example`:

```env
# =============================================================================
# PRINT E-COMMERCE STRAPI BACKEND CONFIGURATION
# =============================================================================

# -----------------------------------------------------------------------------
# Server Configuration
# -----------------------------------------------------------------------------
HOST=0.0.0.0
PORT=1337
PUBLIC_URL=http://localhost:1337
NODE_ENV=development

# -----------------------------------------------------------------------------
# Database Configuration (PostgreSQL)
# -----------------------------------------------------------------------------
DATABASE_CLIENT=postgres
DATABASE_HOST=127.0.0.1
DATABASE_PORT=5432
DATABASE_NAME=print_ecommerce
DATABASE_USERNAME=postgres
DATABASE_PASSWORD=
DATABASE_SSL=false

# For production, use connection string:
# DATABASE_URL=postgres://user:password@host:5432/dbname?sslmode=require

# -----------------------------------------------------------------------------
# Security Keys (MUST be unique for each deployment!)
# Generate with: openssl rand -base64 32
# -----------------------------------------------------------------------------
APP_KEYS=key1,key2,key3,key4
ADMIN_JWT_SECRET=
API_TOKEN_SALT=
JWT_SECRET=
TRANSFER_TOKEN_SALT=

# -----------------------------------------------------------------------------
# Cloudinary (for Strapi media uploads)
# -----------------------------------------------------------------------------
CLOUDINARY_NAME=
CLOUDINARY_KEY=
CLOUDINARY_SECRET=

# -----------------------------------------------------------------------------
# Supabase (for webhook authentication)
# -----------------------------------------------------------------------------
SUPABASE_URL=
SUPABASE_SERVICE_ROLE_KEY=
SUPABASE_WEBHOOK_SECRET=

# -----------------------------------------------------------------------------
# PayPlus (for payment webhooks)
# -----------------------------------------------------------------------------
PAYPLUS_API_KEY=
PAYPLUS_SECRET_KEY=
PAYPLUS_WEBHOOK_SECRET=

# -----------------------------------------------------------------------------
# Resend (for transactional emails)
# -----------------------------------------------------------------------------
RESEND_API_KEY=
RESEND_FROM_EMAIL=orders@yourdomain.com
RESEND_FROM_NAME=Print Company

# -----------------------------------------------------------------------------
# Vultr Object Storage (for file archival)
# -----------------------------------------------------------------------------
VULTR_STORAGE_HOSTNAME=
VULTR_STORAGE_ACCESS_KEY=
VULTR_STORAGE_SECRET_KEY=
VULTR_STORAGE_BUCKET=

# -----------------------------------------------------------------------------
# Frontend URL (for redirects and emails)
# -----------------------------------------------------------------------------
FRONTEND_URL=http://localhost:9000

# -----------------------------------------------------------------------------
# Webhook URLs (set these in external services)
# -----------------------------------------------------------------------------
# Supabase webhook: ${PUBLIC_URL}/api/auth/supabase-webhook
# PayPlus webhook: ${PUBLIC_URL}/api/orders/payment-webhook
```

### Step 3: Create Environment Validation

Create `frontend/src/utils/env.ts`:

```typescript
// Validate required environment variables
const requiredEnvVars = [
  'VITE_STRAPI_URL',
  'VITE_SUPABASE_URL',
  'VITE_SUPABASE_ANON_KEY',
  'VITE_CLOUDINARY_CLOUD_NAME',
];

export function validateEnv(): void {
  const missing: string[] = [];

  for (const envVar of requiredEnvVars) {
    if (!import.meta.env[envVar]) {
      missing.push(envVar);
    }
  }

  if (missing.length > 0) {
    console.error('Missing required environment variables:', missing);
    if (import.meta.env.PROD) {
      throw new Error(`Missing environment variables: ${missing.join(', ')}`);
    }
  }
}

// Type-safe environment variable access
export const env = {
  strapiUrl: import.meta.env.VITE_STRAPI_URL as string,
  strapiApiToken: import.meta.env.VITE_STRAPI_API_TOKEN as string,
  supabaseUrl: import.meta.env.VITE_SUPABASE_URL as string,
  supabaseAnonKey: import.meta.env.VITE_SUPABASE_ANON_KEY as string,
  cloudinaryCloudName: import.meta.env.VITE_CLOUDINARY_CLOUD_NAME as string,
  cloudinaryUploadPreset: import.meta.env.VITE_CLOUDINARY_UPLOAD_PRESET as string,
  cloudinaryApiKey: import.meta.env.VITE_CLOUDINARY_API_KEY as string,
  payPlusApiKey: import.meta.env.VITE_PAYPLUS_API_KEY as string,
  payPlusSecretKey: import.meta.env.VITE_PAYPLUS_SECRET_KEY as string,
  payPlusPageUid: import.meta.env.VITE_PAYPLUS_PAGE_UID as string,
  payPlusMode: (import.meta.env.VITE_PAYPLUS_MODE as string) || 'sandbox',
  gaMeasurementId: import.meta.env.VITE_GA_MEASUREMENT_ID as string,
  defaultLocale: (import.meta.env.VITE_DEFAULT_LOCALE as string) || 'he',
  companyName: (import.meta.env.VITE_COMPANY_NAME as string) || 'Print Company',
  currencyCode: (import.meta.env.VITE_CURRENCY_CODE as string) || 'ILS',
  currencySymbol: (import.meta.env.VITE_CURRENCY_SYMBOL as string) || '₪',
  enableReviews: import.meta.env.VITE_ENABLE_REVIEWS === 'true',
  enableWishlist: import.meta.env.VITE_ENABLE_WISHLIST === 'true',
  enableLiveChat: import.meta.env.VITE_ENABLE_LIVE_CHAT === 'true',
  isDev: import.meta.env.DEV,
  isProd: import.meta.env.PROD,
};
```

### Step 4: Update Vite Type Definitions

Create `frontend/src/env.d.ts`:

```typescript
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_STRAPI_URL: string;
  readonly VITE_STRAPI_API_TOKEN: string;
  readonly VITE_SUPABASE_URL: string;
  readonly VITE_SUPABASE_ANON_KEY: string;
  readonly VITE_CLOUDINARY_CLOUD_NAME: string;
  readonly VITE_CLOUDINARY_UPLOAD_PRESET: string;
  readonly VITE_CLOUDINARY_API_KEY: string;
  readonly VITE_PAYPLUS_API_KEY: string;
  readonly VITE_PAYPLUS_SECRET_KEY: string;
  readonly VITE_PAYPLUS_PAGE_UID: string;
  readonly VITE_PAYPLUS_MODE: 'sandbox' | 'live';
  readonly VITE_GA_MEASUREMENT_ID: string;
  readonly VITE_DEFAULT_LOCALE: string;
  readonly VITE_COMPANY_NAME: string;
  readonly VITE_CURRENCY_CODE: string;
  readonly VITE_CURRENCY_SYMBOL: string;
  readonly VITE_ENABLE_REVIEWS: string;
  readonly VITE_ENABLE_WISHLIST: string;
  readonly VITE_ENABLE_LIVE_CHAT: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

### Step 5: Add .env to .gitignore

Update `frontend/.gitignore`:

```gitignore
# Environment files
.env
.env.local
.env.*.local
!.env.example
```

Update `backend/.gitignore`:

```gitignore
# Environment files
.env
.env.local
!.env.example
```

### Step 6: Create Setup Script

Create `scripts/setup-env.sh`:

```bash
#!/bin/bash

echo "Setting up environment files..."

# Frontend
if [ ! -f frontend/.env ]; then
  cp frontend/.env.example frontend/.env
  echo "Created frontend/.env - please fill in the values"
else
  echo "frontend/.env already exists"
fi

# Backend
if [ ! -f backend/.env ]; then
  cp backend/.env.example backend/.env
  echo "Created backend/.env - please fill in the values"
else
  echo "backend/.env already exists"
fi

echo ""
echo "Next steps:"
echo "1. Edit frontend/.env with your API keys"
echo "2. Edit backend/.env with your database and API credentials"
echo "3. Generate unique security keys for backend"
echo ""
echo "Generate keys with: openssl rand -base64 32"
```

Make executable:

```bash
chmod +x scripts/setup-env.sh
```

## Files Created
- `frontend/.env.example`
- `frontend/src/utils/env.ts`
- `frontend/src/env.d.ts`
- `backend/.env.example`
- `scripts/setup-env.sh`

## Acceptance Criteria
- [ ] `.env.example` files document all variables
- [ ] Actual `.env` files are gitignored
- [ ] TypeScript recognizes environment variables
- [ ] Environment validation runs on app start
- [ ] Setup script creates env files from examples
- [ ] Both frontend and backend load env vars correctly
