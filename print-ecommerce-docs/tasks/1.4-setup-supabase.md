# Task 1.4: Setup Supabase Authentication

## Goal
Configure Supabase for authentication only (email, Google OAuth, Magic Links) with SSR support.

## Prerequisites
- Supabase account created
- Supabase project created
- Task 1.1-1.3 completed

## Instructions

### Step 1: Install Supabase Client

```bash
cd frontend
npm install @supabase/supabase-js @supabase/ssr
```

### Step 2: Get Supabase Credentials

1. Go to https://supabase.com/dashboard
2. Select your project
3. Go to Settings → API
4. Copy:
   - Project URL
   - anon public key

### Step 3: Configure Environment Variables

Update `frontend/.env`:

```env
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key-here
```

### Step 4: Create Supabase Boot File

Create `frontend/src/boot/supabase-auth.ts`:

```typescript
import { boot } from 'quasar/wrappers';
import { createBrowserClient, createServerClient, parseCookieHeader } from '@supabase/ssr';
import type { SupabaseClient } from '@supabase/supabase-js';

// Declare module augmentation for SSR context
declare module '@quasar/app-vite' {
  interface QSsrContext {
    supabase: SupabaseClient;
  }
}

// Client-side Supabase instance
let browserClient: SupabaseClient | null = null;

export function getSupabaseClient(): SupabaseClient {
  if (browserClient) return browserClient;

  browserClient = createBrowserClient(
    import.meta.env.VITE_SUPABASE_URL,
    import.meta.env.VITE_SUPABASE_ANON_KEY,
    {
      cookies: {
        get(name: string) {
          const cookies = document.cookie.split(';');
          const cookie = cookies.find((c) => c.trim().startsWith(`${name}=`));
          return cookie ? decodeURIComponent(cookie.split('=')[1]) : undefined;
        },
        set(name: string, value: string, options: { path?: string; maxAge?: number; domain?: string; secure?: boolean; sameSite?: string }) {
          let cookieStr = `${name}=${encodeURIComponent(value)}`;
          if (options.path) cookieStr += `; path=${options.path}`;
          if (options.maxAge) cookieStr += `; max-age=${options.maxAge}`;
          if (options.secure) cookieStr += '; secure';
          if (options.sameSite) cookieStr += `; samesite=${options.sameSite}`;
          document.cookie = cookieStr;
        },
        remove(name: string, options: { path?: string }) {
          document.cookie = `${name}=; path=${options.path || '/'}; max-age=0`;
        },
      },
    }
  );

  return browserClient;
}

export default boot(async ({ ssrContext }) => {
  if (process.env.SERVER && ssrContext) {
    // Server-side: Create client with request cookies
    const cookies = parseCookieHeader(ssrContext.req.headers.cookie || '');

    const serverClient = createServerClient(
      process.env.VITE_SUPABASE_URL!,
      process.env.VITE_SUPABASE_ANON_KEY!,
      {
        cookies: {
          get(name: string) {
            return cookies[name]?.[0];
          },
          set(name: string, value: string, options: { path?: string; maxAge?: number }) {
            ssrContext.res.setHeader(
              'Set-Cookie',
              `${name}=${encodeURIComponent(value)}; path=${options.path || '/'}; max-age=${options.maxAge || 3600}; httponly; samesite=lax`
            );
          },
          remove(name: string, options: { path?: string }) {
            ssrContext.res.setHeader(
              'Set-Cookie',
              `${name}=; path=${options.path || '/'}; max-age=0`
            );
          },
        },
      }
    );

    ssrContext.supabase = serverClient;
  }
});
```

### Step 5: Create Auth Composable

Create `frontend/src/composables/useAuth.ts`:

```typescript
import { ref, computed, onMounted } from 'vue';
import { getSupabaseClient } from 'src/boot/supabase-auth';
import type { User, Session, AuthError } from '@supabase/supabase-js';

const user = ref<User | null>(null);
const session = ref<Session | null>(null);
const loading = ref(true);

export function useAuth() {
  const supabase = getSupabaseClient();

  const isAuthenticated = computed(() => !!user.value);

  // Initialize auth state
  const initAuth = async () => {
    try {
      loading.value = true;
      const { data: { session: currentSession } } = await supabase.auth.getSession();
      session.value = currentSession;
      user.value = currentSession?.user ?? null;
    } catch (error) {
      console.error('Error initializing auth:', error);
    } finally {
      loading.value = false;
    }
  };

  // Listen for auth changes
  const setupAuthListener = () => {
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, currentSession) => {
        session.value = currentSession;
        user.value = currentSession?.user ?? null;

        if (event === 'SIGNED_IN') {
          // Sync user to Strapi via webhook (handled by Strapi)
          console.log('User signed in:', user.value?.email);
        }
      }
    );

    return subscription;
  };

  // Sign up with email/password
  const signUp = async (email: string, password: string, metadata?: { full_name?: string }) => {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: metadata,
        emailRedirectTo: `${window.location.origin}/auth/callback`,
      },
    });
    return { data, error };
  };

  // Sign in with email/password
  const signIn = async (email: string, password: string) => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    return { data, error };
  };

  // Sign in with Google
  const signInWithGoogle = async () => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${window.location.origin}/auth/callback`,
      },
    });
    return { data, error };
  };

  // Sign in with magic link
  const signInWithMagicLink = async (email: string) => {
    const { data, error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: `${window.location.origin}/auth/callback`,
      },
    });
    return { data, error };
  };

  // Sign out
  const signOut = async () => {
    const { error } = await supabase.auth.signOut();
    if (!error) {
      user.value = null;
      session.value = null;
    }
    return { error };
  };

  // Reset password
  const resetPassword = async (email: string) => {
    const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${window.location.origin}/auth/reset-password`,
    });
    return { data, error };
  };

  // Update password
  const updatePassword = async (newPassword: string) => {
    const { data, error } = await supabase.auth.updateUser({
      password: newPassword,
    });
    return { data, error };
  };

  // Update user profile
  const updateProfile = async (updates: { full_name?: string; avatar_url?: string }) => {
    const { data, error } = await supabase.auth.updateUser({
      data: updates,
    });
    return { data, error };
  };

  return {
    user,
    session,
    loading,
    isAuthenticated,
    initAuth,
    setupAuthListener,
    signUp,
    signIn,
    signInWithGoogle,
    signInWithMagicLink,
    signOut,
    resetPassword,
    updatePassword,
    updateProfile,
  };
}
```

### Step 6: Create Auth Callback Page

Create `frontend/src/pages/auth/CallbackPage.vue`:

```vue
<template>
  <q-page class="flex flex-center">
    <q-spinner-dots size="50px" color="primary" />
    <p class="q-mt-md">{{ $t('common.loading') }}</p>
  </q-page>
</template>

<script setup lang="ts">
import { onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { getSupabaseClient } from 'src/boot/supabase-auth';

const router = useRouter();

onMounted(async () => {
  const supabase = getSupabaseClient();

  // Handle the OAuth or magic link callback
  const { data, error } = await supabase.auth.exchangeCodeForSession(
    window.location.href
  );

  if (error) {
    console.error('Auth callback error:', error);
    router.push('/auth/login?error=callback_failed');
    return;
  }

  if (data.session) {
    // Redirect to intended page or home
    const redirectTo = sessionStorage.getItem('authRedirect') || '/';
    sessionStorage.removeItem('authRedirect');
    router.push(redirectTo);
  }
});
</script>
```

### Step 7: Configure Supabase Auth Providers

In Supabase Dashboard:

1. **Enable Email Auth:**
   - Go to Authentication → Providers
   - Enable Email provider
   - Configure email templates for Hebrew

2. **Enable Google OAuth:**
   - Go to Authentication → Providers → Google
   - Add your Google OAuth credentials
   - Set redirect URL: `https://your-project.supabase.co/auth/v1/callback`

3. **Configure Magic Links:**
   - Email provider settings
   - Magic link is automatically enabled with Email

4. **Set Redirect URLs:**
   - Go to Authentication → URL Configuration
   - Add Site URL: `http://localhost:9000` (dev)
   - Add Redirect URLs: `http://localhost:9000/auth/callback`

### Step 8: Create Auth Webhook for Strapi Sync

In Supabase Dashboard:

1. Go to Database → Webhooks
2. Create new webhook:
   - Name: `sync-user-to-strapi`
   - Table: `auth.users`
   - Events: `INSERT`
   - URL: `http://your-strapi-url/api/auth/supabase-webhook`
   - HTTP Headers: `Authorization: Bearer YOUR_WEBHOOK_SECRET`

### Step 9: Update Routes

Update `frontend/src/router/routes.ts`:

```typescript
const routes = [
  {
    path: '/',
    component: () => import('layouts/MainLayout.vue'),
    children: [
      { path: '', component: () => import('pages/IndexPage.vue') },
      // ... other routes
    ],
  },
  {
    path: '/auth',
    component: () => import('layouts/AuthLayout.vue'),
    children: [
      { path: 'login', component: () => import('pages/auth/LoginPage.vue') },
      { path: 'register', component: () => import('pages/auth/RegisterPage.vue') },
      { path: 'callback', component: () => import('pages/auth/CallbackPage.vue') },
      { path: 'forgot-password', component: () => import('pages/auth/ForgotPasswordPage.vue') },
      { path: 'reset-password', component: () => import('pages/auth/ResetPasswordPage.vue') },
    ],
  },
];

export default routes;
```

## Files Created
- `frontend/src/boot/supabase-auth.ts`
- `frontend/src/composables/useAuth.ts`
- `frontend/src/pages/auth/CallbackPage.vue`

## Acceptance Criteria
- [ ] Supabase client initializes on both server and client
- [ ] Email/password signup works
- [ ] Email/password signin works
- [ ] Google OAuth redirects and returns user
- [ ] Magic link email sends and works
- [ ] Auth state persists across page reloads
- [ ] SSR renders authenticated state correctly
- [ ] Sign out clears session
- [ ] Password reset flow works
