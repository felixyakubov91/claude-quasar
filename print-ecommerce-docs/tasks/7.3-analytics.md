# Task 7.3: Analytics Integration

## Goal
Integrate Google Analytics 4 with e-commerce tracking.

## Instructions

### Create Analytics Boot File
Create `frontend/src/boot/analytics.ts`:

```typescript
import { boot } from 'quasar/wrappers';
import { Router } from 'vue-router';

declare global {
  interface Window {
    dataLayer: any[];
    gtag: (...args: any[]) => void;
  }
}

const GA_ID = import.meta.env.VITE_GA_MEASUREMENT_ID;

export default boot(({ router }) => {
  if (!GA_ID || import.meta.env.SSR) return;

  // Load gtag.js
  const script = document.createElement('script');
  script.async = true;
  script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_ID}`;
  document.head.appendChild(script);

  window.dataLayer = window.dataLayer || [];
  window.gtag = function gtag() {
    window.dataLayer.push(arguments);
  };
  window.gtag('js', new Date());
  window.gtag('config', GA_ID, {
    send_page_view: false, // We'll send manually for SPA
  });

  // Track page views on route change
  trackPageViews(router);
});

function trackPageViews(router: Router) {
  router.afterEach((to) => {
    if (typeof window.gtag === 'function') {
      window.gtag('event', 'page_view', {
        page_path: to.fullPath,
        page_title: document.title,
      });
    }
  });
}
```

### Create Analytics Service
Create `frontend/src/services/analytics.service.ts`:

```typescript
const GA_ID = import.meta.env.VITE_GA_MEASUREMENT_ID;

class AnalyticsService {
  private isEnabled(): boolean {
    return typeof window !== 'undefined' && typeof window.gtag === 'function' && !!GA_ID;
  }

  // E-commerce: View Product
  viewItem(product: any, locale: string) {
    if (!this.isEnabled()) return;

    const name = locale === 'he'
      ? product.attributes.name_he || product.attributes.name_en
      : product.attributes.name_en;

    window.gtag('event', 'view_item', {
      currency: 'ILS',
      value: product.attributes.sale_price || product.attributes.base_price,
      items: [{
        item_id: product.id,
        item_name: name,
        price: product.attributes.sale_price || product.attributes.base_price,
        item_category: product.attributes.category?.data?.attributes?.name_en,
      }],
    });
  }

  // E-commerce: Add to Cart
  addToCart(product: any, quantity: number, locale: string) {
    if (!this.isEnabled()) return;

    const name = locale === 'he'
      ? product.attributes.name_he || product.attributes.name_en
      : product.attributes.name_en;

    const price = product.attributes.sale_price || product.attributes.base_price;

    window.gtag('event', 'add_to_cart', {
      currency: 'ILS',
      value: price * quantity,
      items: [{
        item_id: product.id,
        item_name: name,
        price,
        quantity,
        item_category: product.attributes.category?.data?.attributes?.name_en,
      }],
    });
  }

  // E-commerce: Remove from Cart
  removeFromCart(item: any, locale: string) {
    if (!this.isEnabled()) return;

    const name = locale === 'he'
      ? item.product?.attributes?.name_he || item.product?.attributes?.name_en
      : item.product?.attributes?.name_en;

    window.gtag('event', 'remove_from_cart', {
      currency: 'ILS',
      value: item.unitPrice * item.quantity,
      items: [{
        item_id: item.productId,
        item_name: name,
        price: item.unitPrice,
        quantity: item.quantity,
      }],
    });
  }

  // E-commerce: View Cart
  viewCart(items: any[], total: number, locale: string) {
    if (!this.isEnabled()) return;

    window.gtag('event', 'view_cart', {
      currency: 'ILS',
      value: total,
      items: items.map(item => ({
        item_id: item.productId,
        item_name: locale === 'he'
          ? item.product?.attributes?.name_he || item.product?.attributes?.name_en
          : item.product?.attributes?.name_en,
        price: item.unitPrice,
        quantity: item.quantity,
      })),
    });
  }

  // E-commerce: Begin Checkout
  beginCheckout(items: any[], total: number, locale: string) {
    if (!this.isEnabled()) return;

    window.gtag('event', 'begin_checkout', {
      currency: 'ILS',
      value: total,
      items: items.map(item => ({
        item_id: item.productId,
        item_name: locale === 'he'
          ? item.product?.attributes?.name_he || item.product?.attributes?.name_en
          : item.product?.attributes?.name_en,
        price: item.unitPrice,
        quantity: item.quantity,
      })),
    });
  }

  // E-commerce: Add Shipping Info
  addShippingInfo(items: any[], total: number, shippingMethod: string, locale: string) {
    if (!this.isEnabled()) return;

    window.gtag('event', 'add_shipping_info', {
      currency: 'ILS',
      value: total,
      shipping_tier: shippingMethod,
      items: items.map(item => ({
        item_id: item.productId,
        item_name: locale === 'he'
          ? item.product?.attributes?.name_he || item.product?.attributes?.name_en
          : item.product?.attributes?.name_en,
        price: item.unitPrice,
        quantity: item.quantity,
      })),
    });
  }

  // E-commerce: Add Payment Info
  addPaymentInfo(items: any[], total: number, paymentType: string, locale: string) {
    if (!this.isEnabled()) return;

    window.gtag('event', 'add_payment_info', {
      currency: 'ILS',
      value: total,
      payment_type: paymentType,
      items: items.map(item => ({
        item_id: item.productId,
        item_name: locale === 'he'
          ? item.product?.attributes?.name_he || item.product?.attributes?.name_en
          : item.product?.attributes?.name_en,
        price: item.unitPrice,
        quantity: item.quantity,
      })),
    });
  }

  // E-commerce: Purchase Complete
  purchase(order: any, items: any[], locale: string) {
    if (!this.isEnabled()) return;

    window.gtag('event', 'purchase', {
      transaction_id: order.order_number,
      currency: 'ILS',
      value: order.total,
      tax: order.tax_amount || 0,
      shipping: order.shipping_cost || 0,
      coupon: order.coupon?.data?.attributes?.code,
      items: items.map(item => ({
        item_id: item.productId,
        item_name: locale === 'he'
          ? item.product_snapshot?.name_he || item.product_snapshot?.name
          : item.product_snapshot?.name,
        price: item.unit_price,
        quantity: item.quantity,
      })),
    });
  }

  // Search
  search(searchTerm: string) {
    if (!this.isEnabled()) return;

    window.gtag('event', 'search', {
      search_term: searchTerm,
    });
  }

  // Login
  login(method: string) {
    if (!this.isEnabled()) return;

    window.gtag('event', 'login', {
      method,
    });
  }

  // Sign Up
  signUp(method: string) {
    if (!this.isEnabled()) return;

    window.gtag('event', 'sign_up', {
      method,
    });
  }

  // Share
  share(contentType: string, itemId: string) {
    if (!this.isEnabled()) return;

    window.gtag('event', 'share', {
      content_type: contentType,
      item_id: itemId,
    });
  }

  // Custom Event
  trackEvent(eventName: string, params?: Record<string, any>) {
    if (!this.isEnabled()) return;

    window.gtag('event', eventName, params);
  }
}

export const analyticsService = new AnalyticsService();
```

### Create Analytics Composable
Create `frontend/src/composables/useAnalytics.ts`:

```typescript
import { useI18n } from 'vue-i18n';
import { analyticsService } from 'src/services/analytics.service';

export function useAnalytics() {
  const { locale } = useI18n();

  const trackProductView = (product: any) => {
    analyticsService.viewItem(product, locale.value);
  };

  const trackAddToCart = (product: any, quantity: number) => {
    analyticsService.addToCart(product, quantity, locale.value);
  };

  const trackRemoveFromCart = (item: any) => {
    analyticsService.removeFromCart(item, locale.value);
  };

  const trackViewCart = (items: any[], total: number) => {
    analyticsService.viewCart(items, total, locale.value);
  };

  const trackBeginCheckout = (items: any[], total: number) => {
    analyticsService.beginCheckout(items, total, locale.value);
  };

  const trackAddShippingInfo = (items: any[], total: number, shippingMethod: string) => {
    analyticsService.addShippingInfo(items, total, shippingMethod, locale.value);
  };

  const trackAddPaymentInfo = (items: any[], total: number, paymentType: string) => {
    analyticsService.addPaymentInfo(items, total, paymentType, locale.value);
  };

  const trackPurchase = (order: any, items: any[]) => {
    analyticsService.purchase(order, items, locale.value);
  };

  const trackSearch = (term: string) => {
    analyticsService.search(term);
  };

  const trackLogin = (method: string) => {
    analyticsService.login(method);
  };

  const trackSignUp = (method: string) => {
    analyticsService.signUp(method);
  };

  const trackEvent = (name: string, params?: Record<string, any>) => {
    analyticsService.trackEvent(name, params);
  };

  return {
    trackProductView,
    trackAddToCart,
    trackRemoveFromCart,
    trackViewCart,
    trackBeginCheckout,
    trackAddShippingInfo,
    trackAddPaymentInfo,
    trackPurchase,
    trackSearch,
    trackLogin,
    trackSignUp,
    trackEvent,
  };
}
```

### Integrate Analytics in Components

Update `frontend/src/pages/products/[slug].vue`:
```vue
<script setup lang="ts">
import { useAnalytics } from 'src/composables/useAnalytics';

const { trackProductView, trackAddToCart } = useAnalytics();

// Track product view when loaded
watch(product, (p) => {
  if (p) trackProductView(p);
}, { immediate: true });

// Track add to cart
const handleAddToCart = () => {
  cartStore.addItem(product.value, quantity.value, selectedOptions.value);
  trackAddToCart(product.value, quantity.value);
};
</script>
```

Update cart store to track removals:
```typescript
// In cart.store.ts
import { analyticsService } from 'src/services/analytics.service';

const removeItem = (id: string) => {
  const item = items.value.find(i => i.id === id);
  if (item) {
    analyticsService.removeFromCart(item, 'he'); // Get locale from store
    const index = items.value.findIndex(i => i.id === id);
    if (index > -1) items.value.splice(index, 1);
  }
};
```

### Update Quasar Config
Add boot file to `quasar.config.js`:

```javascript
boot: [
  'i18n',
  'supabase-auth',
  'strapi',
  'cloudinary',
  'analytics', // Add this
],
```

### Environment Variable
Add to `.env`:
```
VITE_GA_MEASUREMENT_ID=G-XXXXXXXXXX
```

## Acceptance Criteria
- [ ] Page views track on navigation
- [ ] Product views track
- [ ] Add to cart tracks
- [ ] Remove from cart tracks
- [ ] Begin checkout tracks
- [ ] Purchase complete tracks
- [ ] Search tracks
- [ ] Login/signup track
- [ ] Events appear in GA4 dashboard
