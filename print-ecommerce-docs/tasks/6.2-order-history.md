# Task 6.2: Order History

## Goal
Build order history with list and detail views.

## Instructions

### Create Orders Page
Create `frontend/src/pages/profile/OrdersPage.vue`:

```vue
<template>
  <q-page class="q-pa-md">
    <div class="row justify-center">
      <div class="col-12 col-md-10">
        <h1 class="text-h4 q-mb-lg">{{ $t('orders.myOrders') }}</h1>

        <q-table
          :rows="orders"
          :columns="columns"
          row-key="id"
          :loading="loading"
          :pagination="pagination"
          @request="onRequest"
          flat
          bordered
        >
          <template v-slot:body-cell-order_number="props">
            <q-td :props="props">
              <router-link
                :to="{ name: 'order-detail', params: { id: props.row.id } }"
                class="text-primary"
              >
                {{ props.row.attributes.order_number }}
              </router-link>
            </q-td>
          </template>

          <template v-slot:body-cell-status="props">
            <q-td :props="props">
              <q-badge :color="getStatusColor(props.row.attributes.status)">
                {{ $t(`orders.status.${props.row.attributes.status}`) }}
              </q-badge>
            </q-td>
          </template>

          <template v-slot:body-cell-payment_status="props">
            <q-td :props="props">
              <q-badge
                :color="props.row.attributes.payment_status === 'paid' ? 'positive' : 'warning'"
              >
                {{ $t(`orders.payment.${props.row.attributes.payment_status}`) }}
              </q-badge>
            </q-td>
          </template>

          <template v-slot:body-cell-total="props">
            <q-td :props="props" class="price-display">
              {{ formatPrice(props.row.attributes.total) }}
            </q-td>
          </template>

          <template v-slot:body-cell-createdAt="props">
            <q-td :props="props">
              {{ formatDate(props.row.attributes.createdAt) }}
            </q-td>
          </template>

          <template v-slot:body-cell-actions="props">
            <q-td :props="props">
              <q-btn
                flat
                dense
                icon="visibility"
                :to="{ name: 'order-detail', params: { id: props.row.id } }"
              />
              <q-btn
                v-if="props.row.attributes.status === 'delivered'"
                flat
                dense
                icon="refresh"
                @click="reorder(props.row)"
              />
            </q-td>
          </template>

          <template v-slot:no-data>
            <div class="full-width text-center q-pa-xl">
              <q-icon name="receipt_long" size="64px" color="grey-4" />
              <p class="text-grey-6 q-mt-md">{{ $t('orders.noOrders') }}</p>
              <q-btn
                color="primary"
                :label="$t('orders.startShopping')"
                :to="{ name: 'products' }"
              />
            </div>
          </template>
        </q-table>
      </div>
    </div>
  </q-page>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useI18n } from 'vue-i18n';
import { useAuth } from 'src/composables/useAuth';
import { useCartStore } from 'src/stores/cart.store';
import { strapiService } from 'src/services/strapi.service';
import { format } from 'date-fns';
import { he, enUS } from 'date-fns/locale';
import { env } from 'src/utils/env';

const router = useRouter();
const { t, locale } = useI18n();
const { user, session } = useAuth();
const cartStore = useCartStore();

const orders = ref<any[]>([]);
const loading = ref(false);
const pagination = ref({
  page: 1,
  rowsPerPage: 10,
  rowsNumber: 0,
});

const columns = [
  { name: 'order_number', label: t('orders.orderNumber'), field: 'order_number', align: 'left' as const },
  { name: 'createdAt', label: t('orders.date'), field: 'createdAt', align: 'left' as const },
  { name: 'status', label: t('orders.status.label'), field: 'status', align: 'center' as const },
  { name: 'payment_status', label: t('orders.payment.label'), field: 'payment_status', align: 'center' as const },
  { name: 'total', label: t('orders.total'), field: 'total', align: 'right' as const },
  { name: 'actions', label: '', field: 'actions', align: 'center' as const },
];

const statusColors: Record<string, string> = {
  pending: 'grey',
  confirmed: 'info',
  processing: 'info',
  printing: 'primary',
  shipped: 'accent',
  delivered: 'positive',
  cancelled: 'negative',
};

const getStatusColor = (status: string) => statusColors[status] || 'grey';

const formatPrice = (price: number) => `${env.currencySymbol}${(price || 0).toFixed(2)}`;

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return format(date, 'dd/MM/yyyy', {
    locale: locale.value === 'he' ? he : enUS,
  });
};

const onRequest = async (props: any) => {
  const { page, rowsPerPage } = props.pagination;
  await loadOrders(page, rowsPerPage);
};

const loadOrders = async (page = 1, pageSize = 10) => {
  if (!user.value) return;

  loading.value = true;
  try {
    const response = await strapiService.getCustomerOrders(
      user.value.id,
      { page, pageSize },
      session.value?.access_token
    );

    orders.value = response.data;
    pagination.value = {
      page,
      rowsPerPage: pageSize,
      rowsNumber: response.meta?.pagination?.total || 0,
    };
  } finally {
    loading.value = false;
  }
};

const reorder = async (order: any) => {
  const items = order.attributes.items?.data || [];

  for (const item of items) {
    const attrs = item.attributes;
    cartStore.addItem(
      { id: attrs.product?.data?.id, attributes: attrs.product_snapshot },
      attrs.quantity,
      attrs.selected_options || {}
    );
  }

  router.push({ name: 'cart' });
};

onMounted(() => loadOrders());
</script>
```

### Create Order Detail Page
Create `frontend/src/pages/profile/OrderDetailPage.vue`:

```vue
<template>
  <q-page class="q-pa-md">
    <div class="row justify-center">
      <div class="col-12 col-md-10">
        <q-btn
          flat
          icon="arrow_back"
          :label="$t('common.back')"
          class="q-mb-md"
          :to="{ name: 'orders' }"
        />

        <div v-if="loading" class="text-center q-pa-xl">
          <q-spinner size="50px" color="primary" />
        </div>

        <template v-else-if="order">
          <div class="row q-col-gutter-lg">
            <div class="col-12">
              <q-card>
                <q-card-section>
                  <div class="row items-center justify-between">
                    <div>
                      <div class="text-h5">
                        {{ $t('orders.orderNumber') }}: {{ order.order_number }}
                      </div>
                      <div class="text-grey-7">
                        {{ formatDate(order.createdAt) }}
                      </div>
                    </div>
                    <div>
                      <q-badge :color="getStatusColor(order.status)" class="q-pa-sm text-body2">
                        {{ $t(`orders.status.${order.status}`) }}
                      </q-badge>
                    </div>
                  </div>
                </q-card-section>
              </q-card>
            </div>

            <div class="col-12 col-md-8">
              <q-card>
                <q-card-section>
                  <div class="text-h6 q-mb-md">{{ $t('orders.items') }}</div>
                </q-card-section>
                <q-separator />
                <q-list separator>
                  <q-item v-for="item in order.items?.data" :key="item.id">
                    <q-item-section avatar>
                      <q-img
                        :src="item.attributes.product?.data?.attributes?.thumbnail?.data?.attributes?.url"
                        width="80px"
                        height="80px"
                        fit="cover"
                      />
                    </q-item-section>
                    <q-item-section>
                      <q-item-label class="text-weight-medium">
                        {{ item.attributes.product_snapshot?.name }}
                      </q-item-label>
                      <q-item-label caption>
                        {{ $t('products.quantity') }}: {{ item.attributes.quantity }}
                      </q-item-label>
                      <q-item-label caption v-if="item.attributes.selected_options">
                        <span
                          v-for="(value, key) in item.attributes.selected_options"
                          :key="key"
                          class="q-mr-sm"
                        >
                          {{ key }}: {{ value }}
                        </span>
                      </q-item-label>
                    </q-item-section>
                    <q-item-section side class="price-display">
                      {{ formatPrice(item.attributes.total_price) }}
                    </q-item-section>
                  </q-item>
                </q-list>
              </q-card>

              <q-card class="q-mt-md" v-if="order.tracking_number">
                <q-card-section>
                  <div class="text-h6">{{ $t('orders.tracking') }}</div>
                  <div class="q-mt-sm">
                    <span class="text-weight-medium">{{ $t('orders.trackingNumber') }}:</span>
                    {{ order.tracking_number }}
                  </div>
                </q-card-section>
              </q-card>
            </div>

            <div class="col-12 col-md-4">
              <q-card class="q-mb-md">
                <q-card-section>
                  <div class="text-h6 q-mb-md">{{ $t('orders.summary') }}</div>

                  <div class="row justify-between q-mb-sm">
                    <span>{{ $t('cart.subtotal') }}</span>
                    <span class="price-display">{{ formatPrice(order.subtotal) }}</span>
                  </div>

                  <div v-if="order.discount_amount" class="row justify-between q-mb-sm text-positive">
                    <span>{{ $t('cart.discount') }}</span>
                    <span class="price-display">-{{ formatPrice(order.discount_amount) }}</span>
                  </div>

                  <div class="row justify-between q-mb-sm">
                    <span>{{ $t('checkout.shipping') }}</span>
                    <span class="price-display">{{ formatPrice(order.shipping_cost) }}</span>
                  </div>

                  <q-separator class="q-my-md" />

                  <div class="row justify-between text-h6">
                    <span>{{ $t('cart.total') }}</span>
                    <span class="price-display">{{ formatPrice(order.total) }}</span>
                  </div>
                </q-card-section>
              </q-card>

              <q-card class="q-mb-md">
                <q-card-section>
                  <div class="text-h6 q-mb-sm">{{ $t('checkout.shippingAddress') }}</div>
                  <div v-if="order.shipping_address">
                    <div>{{ order.shipping_address.full_name }}</div>
                    <div>{{ order.shipping_address.street_address }}</div>
                    <div>{{ order.shipping_address.city }}, {{ order.shipping_address.postal_code }}</div>
                    <div>{{ order.shipping_address.phone }}</div>
                  </div>
                </q-card-section>
              </q-card>

              <q-card>
                <q-card-section>
                  <div class="text-h6 q-mb-sm">{{ $t('orders.payment.label') }}</div>
                  <q-badge
                    :color="order.payment_status === 'paid' ? 'positive' : 'warning'"
                    class="q-pa-sm"
                  >
                    {{ $t(`orders.payment.${order.payment_status}`) }}
                  </q-badge>
                  <div v-if="order.paid_at" class="q-mt-sm text-grey-7">
                    {{ formatDate(order.paid_at) }}
                  </div>
                </q-card-section>
              </q-card>
            </div>
          </div>
        </template>
      </div>
    </div>
  </q-page>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import { useI18n } from 'vue-i18n';
import { useAuth } from 'src/composables/useAuth';
import { strapiService } from 'src/services/strapi.service';
import { format } from 'date-fns';
import { he, enUS } from 'date-fns/locale';
import { env } from 'src/utils/env';

const route = useRoute();
const { locale } = useI18n();
const { session } = useAuth();

const order = ref<any>(null);
const loading = ref(true);

const statusColors: Record<string, string> = {
  pending: 'grey',
  confirmed: 'info',
  processing: 'info',
  printing: 'primary',
  shipped: 'accent',
  delivered: 'positive',
  cancelled: 'negative',
};

const getStatusColor = (status: string) => statusColors[status] || 'grey';

const formatPrice = (price: number) => `${env.currencySymbol}${(price || 0).toFixed(2)}`;

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return format(date, 'dd/MM/yyyy HH:mm', {
    locale: locale.value === 'he' ? he : enUS,
  });
};

onMounted(async () => {
  const orderId = route.params.id as string;
  try {
    const response = await strapiService.getOrder(orderId, session.value?.access_token);
    order.value = response.data?.attributes;
  } finally {
    loading.value = false;
  }
});
</script>
```

### Add useOrders Composable
Create `frontend/src/composables/useOrders.ts`:

```typescript
import { ref } from 'vue';
import { strapiService } from 'src/services/strapi.service';
import { useAuth } from './useAuth';

export function useOrders() {
  const { user, session } = useAuth();
  const orders = ref<any[]>([]);
  const loading = ref(false);
  const error = ref<string | null>(null);

  const fetchOrders = async (page = 1, pageSize = 10) => {
    if (!user.value) return;

    loading.value = true;
    error.value = null;

    try {
      const response = await strapiService.getCustomerOrders(
        user.value.id,
        { page, pageSize },
        session.value?.access_token
      );
      orders.value = response.data;
      return response;
    } catch (e) {
      error.value = 'Failed to fetch orders';
      throw e;
    } finally {
      loading.value = false;
    }
  };

  const fetchOrder = async (orderId: string) => {
    loading.value = true;
    error.value = null;

    try {
      const response = await strapiService.getOrder(orderId, session.value?.access_token);
      return response.data;
    } catch (e) {
      error.value = 'Failed to fetch order';
      throw e;
    } finally {
      loading.value = false;
    }
  };

  return {
    orders,
    loading,
    error,
    fetchOrders,
    fetchOrder,
  };
}
```

## Acceptance Criteria
- [ ] Order list displays correctly
- [ ] Order detail shows all info
- [ ] Status badges work
- [ ] Reorder functionality works
- [ ] Pagination works
