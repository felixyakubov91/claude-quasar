# Task 8.4: Testing

## Goal
Test core user flows and ensure quality.

## Instructions

### Set Up Testing Environment
Install testing dependencies:

```bash
cd frontend
npm install -D vitest @vue/test-utils @testing-library/vue happy-dom
```

Update `frontend/vitest.config.ts`:

```typescript
import { defineConfig } from 'vitest/config';
import vue from '@vitejs/plugin-vue';
import { quasar, transformAssetUrls } from '@quasar/vite-plugin';
import path from 'path';

export default defineConfig({
  plugins: [
    vue({ template: { transformAssetUrls } }),
    quasar({ sassVariables: 'src/css/quasar.variables.scss' }),
  ],
  test: {
    environment: 'happy-dom',
    globals: true,
    setupFiles: ['./tests/setup.ts'],
  },
  resolve: {
    alias: {
      src: path.resolve(__dirname, './src'),
    },
  },
});
```

Create `frontend/tests/setup.ts`:

```typescript
import { config } from '@vue/test-utils';
import { createI18n } from 'vue-i18n';
import { Quasar } from 'quasar';
import { createTestingPinia } from '@pinia/testing';
import { vi } from 'vitest';

// Mock vue-i18n
const i18n = createI18n({
  legacy: false,
  locale: 'en-US',
  messages: {
    'en-US': {
      products: { addToCart: 'Add to Cart' },
      cart: { empty: 'Cart is empty' },
    },
  },
});

config.global.plugins = [Quasar, i18n, createTestingPinia()];

// Mock router
config.global.mocks = {
  $route: { params: {}, query: {} },
  $router: { push: vi.fn(), replace: vi.fn() },
};

// Mock window.matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation((query) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});
```

### Create Cart Store Tests
Create `frontend/tests/stores/cart.store.test.ts`:

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { setActivePinia, createPinia } from 'pinia';
import { useCartStore } from 'src/stores/cart.store';

describe('Cart Store', () => {
  beforeEach(() => {
    setActivePinia(createPinia());
    localStorage.clear();
  });

  it('adds item to cart', () => {
    const store = useCartStore();
    const product = {
      id: 1,
      attributes: { name_en: 'Test Product', base_price: 100 },
    };

    store.addItem(product, 2, { size: 'large' });

    expect(store.items).toHaveLength(1);
    expect(store.items[0].quantity).toBe(2);
    expect(store.itemCount).toBe(2);
  });

  it('increases quantity for existing item', () => {
    const store = useCartStore();
    const product = {
      id: 1,
      attributes: { name_en: 'Test Product', base_price: 100 },
    };

    store.addItem(product, 1, { size: 'large' });
    store.addItem(product, 2, { size: 'large' });

    expect(store.items).toHaveLength(1);
    expect(store.items[0].quantity).toBe(3);
  });

  it('treats different options as separate items', () => {
    const store = useCartStore();
    const product = {
      id: 1,
      attributes: { name_en: 'Test Product', base_price: 100 },
    };

    store.addItem(product, 1, { size: 'small' });
    store.addItem(product, 1, { size: 'large' });

    expect(store.items).toHaveLength(2);
  });

  it('removes item from cart', () => {
    const store = useCartStore();
    const product = {
      id: 1,
      attributes: { name_en: 'Test Product', base_price: 100 },
    };

    store.addItem(product, 1, {});
    const itemId = store.items[0].id;
    store.removeItem(itemId);

    expect(store.items).toHaveLength(0);
  });

  it('updates item quantity', () => {
    const store = useCartStore();
    const product = {
      id: 1,
      attributes: { name_en: 'Test Product', base_price: 100 },
    };

    store.addItem(product, 1, {});
    const itemId = store.items[0].id;
    store.updateQuantity(itemId, 5);

    expect(store.items[0].quantity).toBe(5);
  });

  it('calculates subtotal correctly', () => {
    const store = useCartStore();

    store.addItem(
      { id: 1, attributes: { base_price: 100 } },
      2,
      {}
    );
    store.addItem(
      { id: 2, attributes: { base_price: 50 } },
      3,
      {}
    );

    expect(store.subtotal).toBe(350); // 100*2 + 50*3
  });

  it('clears cart', () => {
    const store = useCartStore();

    store.addItem({ id: 1, attributes: { base_price: 100 } }, 1, {});
    store.addItem({ id: 2, attributes: { base_price: 50 } }, 1, {});
    store.clearCart();

    expect(store.items).toHaveLength(0);
    expect(store.subtotal).toBe(0);
  });
});
```

### Create Component Tests
Create `frontend/tests/components/ProductCard.test.ts`:

```typescript
import { describe, it, expect, vi } from 'vitest';
import { mount } from '@vue/test-utils';
import ProductCard from 'src/components/products/ProductCard.vue';

const mockProduct = {
  id: 1,
  attributes: {
    name_en: 'Test Product',
    name_he: 'מוצר בדיקה',
    slug: 'test-product',
    base_price: 100,
    sale_price: 80,
    thumbnail: {
      data: {
        attributes: {
          url: 'https://example.com/image.jpg',
        },
      },
    },
  },
};

describe('ProductCard', () => {
  it('renders product name', () => {
    const wrapper = mount(ProductCard, {
      props: { product: mockProduct },
    });

    expect(wrapper.text()).toContain('Test Product');
  });

  it('displays sale badge when product is on sale', () => {
    const wrapper = mount(ProductCard, {
      props: { product: mockProduct },
    });

    expect(wrapper.find('.q-badge').exists()).toBe(true);
    expect(wrapper.text()).toContain('-20%');
  });

  it('shows original price crossed out when on sale', () => {
    const wrapper = mount(ProductCard, {
      props: { product: mockProduct },
    });

    expect(wrapper.find('.text-strike').text()).toContain('100');
  });

  it('navigates to product page on click', async () => {
    const push = vi.fn();
    const wrapper = mount(ProductCard, {
      props: { product: mockProduct },
      global: {
        mocks: {
          $router: { push },
        },
      },
    });

    await wrapper.trigger('click');

    expect(push).toHaveBeenCalledWith({
      name: 'product',
      params: { slug: 'test-product' },
    });
  });

  it('adds to cart on button click', async () => {
    const wrapper = mount(ProductCard, {
      props: { product: mockProduct },
    });

    await wrapper.find('.q-btn').trigger('click');

    // Check cart store was called
    // This would need the store to be properly mocked
  });
});
```

### Create E2E Test Specs
Create `frontend/tests/e2e/checkout-flow.spec.ts`:

```typescript
// Using Playwright or Cypress
import { test, expect } from '@playwright/test';

test.describe('Checkout Flow', () => {
  test.beforeEach(async ({ page }) => {
    // Clear cart and login
    await page.goto('/');
    await page.evaluate(() => localStorage.clear());
  });

  test('complete checkout as guest', async ({ page }) => {
    // Add product to cart
    await page.goto('/products/business-cards');
    await page.click('text=Add to Cart');

    // Go to cart
    await page.click('[data-testid="cart-icon"]');
    await expect(page.locator('.cart-drawer')).toBeVisible();

    // Proceed to checkout
    await page.click('text=Checkout');
    await expect(page).toHaveURL(/\/checkout/);

    // Fill shipping address
    await page.fill('[name="full_name"]', 'Test User');
    await page.fill('[name="phone"]', '050-1234567');
    await page.fill('[name="street_address"]', 'Test Street 123');
    await page.fill('[name="city"]', 'Tel Aviv');
    await page.fill('[name="postal_code"]', '12345');

    await page.click('text=Next');

    // Select shipping method
    await page.click('text=Standard Shipping');
    await page.click('text=Next');

    // Review order
    await expect(page.locator('.order-review')).toBeVisible();
    await page.click('text=Proceed to Payment');

    // Should redirect to payment
    await expect(page).toHaveURL(/\/checkout\/payment/);
  });

  test('apply coupon code', async ({ page }) => {
    await page.goto('/products/business-cards');
    await page.click('text=Add to Cart');
    await page.click('[data-testid="cart-icon"]');

    // Apply coupon
    await page.fill('[name="coupon"]', 'SAVE10');
    await page.click('text=Apply');

    await expect(page.locator('.text-positive')).toContainText('SAVE10');
    await expect(page.locator('.discount-amount')).toBeVisible();
  });
});

test.describe('Product Browsing', () => {
  test('filter products by category', async ({ page }) => {
    await page.goto('/products');

    await page.click('text=Business Cards');

    await expect(page).toHaveURL(/\/category\/business-cards/);
    await expect(page.locator('.product-card')).toHaveCount({ min: 1 });
  });

  test('search products', async ({ page }) => {
    await page.goto('/');

    await page.fill('[name="search"]', 'cards');
    await page.press('[name="search"]', 'Enter');

    await expect(page).toHaveURL(/\/products\?search=cards/);
  });

  test('view product details', async ({ page }) => {
    await page.goto('/products');

    await page.click('.product-card >> nth=0');

    await expect(page.locator('.product-gallery')).toBeVisible();
    await expect(page.locator('.product-options')).toBeVisible();
    await expect(page.locator('text=Add to Cart')).toBeVisible();
  });
});

test.describe('User Authentication', () => {
  test('login with email', async ({ page }) => {
    await page.goto('/auth/login');

    await page.fill('[name="email"]', 'test@example.com');
    await page.fill('[name="password"]', 'testpassword');
    await page.click('text=Sign In');

    await expect(page).toHaveURL('/');
    await expect(page.locator('[data-testid="user-menu"]')).toBeVisible();
  });

  test('register new account', async ({ page }) => {
    await page.goto('/auth/register');

    await page.fill('[name="email"]', `test-${Date.now()}@example.com`);
    await page.fill('[name="password"]', 'testpassword123');
    await page.fill('[name="full_name"]', 'Test User');
    await page.click('text=Create Account');

    await expect(page.locator('text=Check your email')).toBeVisible();
  });
});

test.describe('RTL Support', () => {
  test('switches to Hebrew', async ({ page }) => {
    await page.goto('/');

    await page.click('[data-testid="language-switcher"]');
    await page.click('text=עברית');

    await expect(page.locator('html')).toHaveAttribute('dir', 'rtl');
    await expect(page.locator('html')).toHaveAttribute('lang', 'he');
  });

  test('cart drawer opens from left in RTL', async ({ page }) => {
    await page.goto('/?lang=he');

    await page.click('[data-testid="cart-icon"]');

    const drawer = page.locator('.cart-drawer');
    const rect = await drawer.boundingBox();

    expect(rect?.x).toBe(0); // Opens from left
  });
});
```

### Add Test Scripts to package.json
```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui"
  }
}
```

## Acceptance Criteria
- [ ] Unit tests pass
- [ ] Cart store tests pass
- [ ] Component tests pass
- [ ] E2E checkout flow passes
- [ ] E2E auth flow passes
- [ ] RTL tests pass
- [ ] Coverage > 60%
