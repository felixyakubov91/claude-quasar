# Task 2.3: Auth Webhook

## Goal
Create Strapi endpoint to sync Supabase users to Customer records.

## Prerequisites
- Task 2.2 completed
- Supabase webhook configured

## Instructions

### Step 1: Create Webhook Controller

Create `backend/src/api/customer/controllers/webhook.js`:

```javascript
'use strict';

const crypto = require('crypto');

module.exports = {
  async supabaseWebhook(ctx) {
    const { event, user } = ctx.request.body;
    const signature = ctx.request.headers['x-supabase-signature'];

    // Verify webhook signature
    const secret = process.env.SUPABASE_WEBHOOK_SECRET;
    const expectedSignature = crypto
      .createHmac('sha256', secret)
      .update(JSON.stringify(ctx.request.body))
      .digest('hex');

    if (signature !== expectedSignature) {
      return ctx.unauthorized('Invalid signature');
    }

    try {
      if (event === 'INSERT' || event === 'signup') {
        // Check if customer already exists
        const existing = await strapi.entityService.findMany(
          'api::customer.customer',
          {
            filters: { supabase_id: user.id },
          }
        );

        if (existing.length === 0) {
          // Create new customer
          await strapi.entityService.create('api::customer.customer', {
            data: {
              supabase_id: user.id,
              email: user.email,
              full_name: user.user_metadata?.full_name || '',
              preferred_language: 'he',
              publishedAt: new Date(),
            },
          });

          strapi.log.info(`Created customer for Supabase user: ${user.email}`);
        }
      } else if (event === 'UPDATE') {
        // Update existing customer
        const existing = await strapi.entityService.findMany(
          'api::customer.customer',
          {
            filters: { supabase_id: user.id },
          }
        );

        if (existing.length > 0) {
          await strapi.entityService.update(
            'api::customer.customer',
            existing[0].id,
            {
              data: {
                email: user.email,
                full_name: user.user_metadata?.full_name || existing[0].full_name,
              },
            }
          );
        }
      } else if (event === 'DELETE') {
        // Soft delete or anonymize customer
        const existing = await strapi.entityService.findMany(
          'api::customer.customer',
          {
            filters: { supabase_id: user.id },
          }
        );

        if (existing.length > 0) {
          await strapi.entityService.update(
            'api::customer.customer',
            existing[0].id,
            {
              data: {
                email: `deleted-${user.id}@deleted.local`,
                full_name: 'Deleted User',
              },
            }
          );
        }
      }

      return ctx.send({ success: true });
    } catch (error) {
      strapi.log.error('Supabase webhook error:', error);
      return ctx.badRequest('Webhook processing failed');
    }
  },
};
```

### Step 2: Create Webhook Route

Create `backend/src/api/customer/routes/webhook.js`:

```javascript
module.exports = {
  routes: [
    {
      method: 'POST',
      path: '/auth/supabase-webhook',
      handler: 'webhook.supabaseWebhook',
      config: {
        auth: false, // Public endpoint (signature verified manually)
        policies: [],
      },
    },
  ],
};
```

### Step 3: Configure Supabase Webhook

In Supabase Dashboard → Database → Webhooks:

1. Create new webhook
2. Name: `sync-to-strapi`
3. Table: `auth.users`
4. Events: INSERT, UPDATE, DELETE
5. URL: `https://your-strapi.com/api/auth/supabase-webhook`
6. Headers:
   - `Content-Type: application/json`
   - `x-supabase-signature: {{signature}}`

### Step 4: Add Environment Variable

Add to `backend/.env`:

```env
SUPABASE_WEBHOOK_SECRET=your-webhook-secret
```

## Acceptance Criteria
- [ ] Webhook endpoint accessible
- [ ] New Supabase users create Customer records
- [ ] User updates sync to Strapi
- [ ] Invalid signatures rejected
- [ ] Errors logged properly
