# Task 8.3: Mobile Optimization

## Goal
Ensure 100% mobile responsiveness with touch-friendly interactions.

## Instructions

### Create Mobile Navigation
Create `frontend/src/components/common/MobileNav.vue`:

```vue
<template>
  <div class="mobile-nav lt-md">
    <q-toolbar class="bg-white shadow-1">
      <q-btn flat round icon="menu" @click="menuOpen = true" />

      <q-toolbar-title class="text-center">
        <router-link :to="{ name: 'home' }">
          <q-img src="/images/logo.svg" width="100px" />
        </router-link>
      </q-toolbar-title>

      <q-btn flat round icon="search" @click="$emit('search')" />
      <q-btn flat round @click="$emit('cart')">
        <q-icon name="shopping_cart" />
        <q-badge v-if="cartCount" color="accent" floating>
          {{ cartCount }}
        </q-badge>
      </q-btn>
    </q-toolbar>

    <q-drawer v-model="menuOpen" side="left" overlay behavior="mobile">
      <q-list>
        <q-item clickable :to="{ name: 'home' }" @click="menuOpen = false">
          <q-item-section avatar>
            <q-icon name="home" />
          </q-item-section>
          <q-item-section>{{ $t('nav.home') }}</q-item-section>
        </q-item>

        <q-item clickable :to="{ name: 'products' }" @click="menuOpen = false">
          <q-item-section avatar>
            <q-icon name="grid_view" />
          </q-item-section>
          <q-item-section>{{ $t('nav.products') }}</q-item-section>
        </q-item>

        <q-expansion-item icon="category" :label="$t('nav.categories')">
          <q-list dense>
            <q-item
              v-for="category in categories"
              :key="category.id"
              clickable
              :to="{ name: 'category', params: { slug: category.attributes.slug } }"
              @click="menuOpen = false"
              class="q-pl-lg"
            >
              <q-item-section>{{ getLocalizedName(category) }}</q-item-section>
            </q-item>
          </q-list>
        </q-expansion-item>

        <q-separator />

        <template v-if="isAuthenticated">
          <q-item clickable :to="{ name: 'profile' }" @click="menuOpen = false">
            <q-item-section avatar>
              <q-icon name="person" />
            </q-item-section>
            <q-item-section>{{ $t('nav.profile') }}</q-item-section>
          </q-item>

          <q-item clickable :to="{ name: 'orders' }" @click="menuOpen = false">
            <q-item-section avatar>
              <q-icon name="receipt_long" />
            </q-item-section>
            <q-item-section>{{ $t('nav.orders') }}</q-item-section>
          </q-item>

          <q-item clickable @click="handleLogout">
            <q-item-section avatar>
              <q-icon name="logout" />
            </q-item-section>
            <q-item-section>{{ $t('nav.logout') }}</q-item-section>
          </q-item>
        </template>

        <template v-else>
          <q-item clickable :to="{ name: 'login' }" @click="menuOpen = false">
            <q-item-section avatar>
              <q-icon name="login" />
            </q-item-section>
            <q-item-section>{{ $t('nav.login') }}</q-item-section>
          </q-item>
        </template>

        <q-separator />

        <q-item>
          <q-item-section>
            <LanguageSwitcher />
          </q-item-section>
        </q-item>
      </q-list>
    </q-drawer>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { useI18n } from 'vue-i18n';
import { useAuth } from 'src/composables/useAuth';
import { useCartStore } from 'src/stores/cart.store';
import LanguageSwitcher from './LanguageSwitcher.vue';

defineProps<{ categories: any[] }>();
defineEmits(['search', 'cart']);

const { locale } = useI18n();
const { isAuthenticated, signOut } = useAuth();
const cartStore = useCartStore();

const menuOpen = ref(false);
const cartCount = computed(() => cartStore.itemCount);

const getLocalizedName = (category: any) => {
  return locale.value === 'he'
    ? category.attributes.name_he || category.attributes.name_en
    : category.attributes.name_en;
};

const handleLogout = async () => {
  await signOut();
  menuOpen.value = false;
};
</script>
```

### Create Mobile Bottom Navigation
Create `frontend/src/components/common/MobileBottomNav.vue`:

```vue
<template>
  <q-footer class="lt-md bg-white shadow-up-1" elevated>
    <q-tabs
      v-model="activeTab"
      class="text-grey-7"
      active-color="primary"
      indicator-color="primary"
      narrow-indicator
    >
      <q-route-tab
        name="home"
        icon="home"
        :label="$t('nav.home')"
        :to="{ name: 'home' }"
      />
      <q-route-tab
        name="products"
        icon="grid_view"
        :label="$t('nav.products')"
        :to="{ name: 'products' }"
      />
      <q-tab
        name="cart"
        icon="shopping_cart"
        :label="$t('nav.cart')"
        @click="$emit('open-cart')"
      >
        <q-badge v-if="cartCount" color="accent" floating>
          {{ cartCount }}
        </q-badge>
      </q-tab>
      <q-route-tab
        name="profile"
        :icon="isAuthenticated ? 'person' : 'login'"
        :label="isAuthenticated ? $t('nav.profile') : $t('nav.login')"
        :to="{ name: isAuthenticated ? 'profile' : 'login' }"
      />
    </q-tabs>
  </q-footer>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { useRoute } from 'vue-router';
import { useAuth } from 'src/composables/useAuth';
import { useCartStore } from 'src/stores/cart.store';

defineEmits(['open-cart']);

const route = useRoute();
const { isAuthenticated } = useAuth();
const cartStore = useCartStore();

const activeTab = ref('home');
const cartCount = computed(() => cartStore.itemCount);

watch(() => route.name, (name) => {
  if (typeof name === 'string') {
    if (name.startsWith('product')) activeTab.value = 'products';
    else if (name.startsWith('profile') || name.startsWith('order')) activeTab.value = 'profile';
    else activeTab.value = name;
  }
}, { immediate: true });
</script>

<style lang="scss" scoped>
.q-footer {
  padding-bottom: env(safe-area-inset-bottom);
}
</style>
```

### Create Touch-Friendly Product Card
Update `frontend/src/components/products/ProductCard.vue`:

```vue
<template>
  <q-card
    class="product-card cursor-pointer"
    @click="navigateToProduct"
    v-touch-hold.mouse="showQuickActions"
  >
    <q-img
      :src="thumbnailUrl"
      :ratio="1"
      class="product-image"
    >
      <div v-if="product.attributes.sale_price" class="absolute-top-left q-pa-xs">
        <q-badge color="accent" :label="discountLabel" />
      </div>

      <template v-slot:loading>
        <q-skeleton square />
      </template>
    </q-img>

    <q-card-section class="q-pa-sm">
      <div class="text-subtitle2 ellipsis-2-lines" style="min-height: 40px">
        {{ localizedName }}
      </div>

      <div class="row items-center q-mt-sm">
        <div class="col">
          <div v-if="product.attributes.sale_price" class="text-strike text-grey-6 text-caption">
            {{ formatPrice(product.attributes.base_price) }}
          </div>
          <div class="text-h6 text-primary price-display">
            {{ formatPrice(currentPrice) }}
          </div>
        </div>
      </div>
    </q-card-section>

    <q-card-actions class="q-pt-none">
      <q-btn
        flat
        color="primary"
        :label="$t('products.addToCart')"
        class="full-width"
        @click.stop="quickAddToCart"
      />
    </q-card-actions>

    <!-- Quick Actions Dialog (long press) -->
    <q-dialog v-model="showQuickActionsDialog">
      <q-card style="min-width: 250px">
        <q-card-section class="text-center">
          <q-img :src="thumbnailUrl" width="100px" />
          <div class="text-subtitle1 q-mt-sm">{{ localizedName }}</div>
        </q-card-section>
        <q-list>
          <q-item clickable v-close-popup @click="quickAddToCart">
            <q-item-section avatar>
              <q-icon name="add_shopping_cart" />
            </q-item-section>
            <q-item-section>{{ $t('products.addToCart') }}</q-item-section>
          </q-item>
          <q-item clickable v-close-popup @click="navigateToProduct">
            <q-item-section avatar>
              <q-icon name="visibility" />
            </q-item-section>
            <q-item-section>{{ $t('products.viewDetails') }}</q-item-section>
          </q-item>
          <q-item clickable v-close-popup @click="shareProduct">
            <q-item-section avatar>
              <q-icon name="share" />
            </q-item-section>
            <q-item-section>{{ $t('common.share') }}</q-item-section>
          </q-item>
        </q-list>
      </q-card>
    </q-dialog>
  </q-card>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { useRouter } from 'vue-router';
import { useQuasar } from 'quasar';
import { useI18n } from 'vue-i18n';
import { useCartStore } from 'src/stores/cart.store';
import { useAnalytics } from 'src/composables/useAnalytics';
import { getOptimizedImageUrl } from 'src/utils/cloudinary';
import { env } from 'src/utils/env';

const props = defineProps<{ product: any }>();

const router = useRouter();
const $q = useQuasar();
const { t, locale } = useI18n();
const cartStore = useCartStore();
const { trackAddToCart } = useAnalytics();

const showQuickActionsDialog = ref(false);

const localizedName = computed(() => {
  return locale.value === 'he'
    ? props.product.attributes.name_he || props.product.attributes.name_en
    : props.product.attributes.name_en;
});

const thumbnailUrl = computed(() => {
  const url = props.product.attributes.thumbnail?.data?.attributes?.url;
  return getOptimizedImageUrl(url, { width: 400, height: 400 });
});

const currentPrice = computed(() =>
  props.product.attributes.sale_price || props.product.attributes.base_price
);

const discountLabel = computed(() => {
  const discount = Math.round(
    (1 - props.product.attributes.sale_price / props.product.attributes.base_price) * 100
  );
  return `-${discount}%`;
});

const formatPrice = (price: number) => `${env.currencySymbol}${price.toFixed(2)}`;

const navigateToProduct = () => {
  router.push({
    name: 'product',
    params: { slug: props.product.attributes.slug },
  });
};

const quickAddToCart = () => {
  cartStore.addItem(props.product, 1, {});
  trackAddToCart(props.product, 1);
  $q.notify({
    type: 'positive',
    message: t('cart.addedToCart'),
    position: 'bottom',
  });
};

const showQuickActions = () => {
  if ($q.platform.is.mobile) {
    showQuickActionsDialog.value = true;
  }
};

const shareProduct = async () => {
  const url = `${env.siteUrl}/products/${props.product.attributes.slug}`;

  if (navigator.share) {
    await navigator.share({
      title: localizedName.value,
      url,
    });
  } else {
    await navigator.clipboard.writeText(url);
    $q.notify({
      type: 'positive',
      message: t('common.linkCopied'),
    });
  }
};
</script>

<style lang="scss" scoped>
.product-card {
  transition: transform 0.2s;

  &:active {
    transform: scale(0.98);
  }
}

.ellipsis-2-lines {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
```

### Create Swipeable Image Gallery
Create `frontend/src/components/products/MobileGallery.vue`:

```vue
<template>
  <div class="mobile-gallery">
    <q-carousel
      v-model="slide"
      animated
      swipeable
      navigation
      arrows
      :autoplay="false"
      height="300px"
    >
      <q-carousel-slide
        v-for="(image, index) in images"
        :key="index"
        :name="index"
        class="q-pa-none"
      >
        <q-img
          :src="getOptimizedUrl(image)"
          fit="contain"
          class="full-height cursor-pointer"
          @click="openFullscreen(index)"
        />
      </q-carousel-slide>
    </q-carousel>

    <div class="row justify-center q-mt-sm q-gutter-xs">
      <div
        v-for="(image, index) in images"
        :key="index"
        class="thumbnail-item"
        :class="{ active: slide === index }"
        @click="slide = index"
      >
        <q-img
          :src="getOptimizedUrl(image, true)"
          width="50px"
          height="50px"
          fit="cover"
        />
      </div>
    </div>

    <!-- Fullscreen Gallery -->
    <q-dialog v-model="fullscreenOpen" maximized>
      <q-carousel
        v-model="fullscreenSlide"
        animated
        swipeable
        navigation
        arrows
        class="bg-black text-white"
      >
        <q-carousel-slide
          v-for="(image, index) in images"
          :key="index"
          :name="index"
          class="flex flex-center"
        >
          <q-img
            :src="image.attributes.url"
            fit="contain"
            style="max-height: 80vh"
            @touchstart="onPinchStart"
            @touchmove="onPinchMove"
          />
        </q-carousel-slide>

        <template v-slot:control>
          <q-carousel-control position="top-right" :offset="[18, 18]">
            <q-btn
              flat
              round
              dense
              icon="close"
              color="white"
              @click="fullscreenOpen = false"
            />
          </q-carousel-control>
        </template>
      </q-carousel>
    </q-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { getOptimizedImageUrl } from 'src/utils/cloudinary';

const props = defineProps<{ images: any[] }>();

const slide = ref(0);
const fullscreenOpen = ref(false);
const fullscreenSlide = ref(0);

const getOptimizedUrl = (image: any, thumbnail = false) => {
  const url = image.attributes?.url;
  if (thumbnail) {
    return getOptimizedImageUrl(url, { width: 100, height: 100 });
  }
  return getOptimizedImageUrl(url, { width: 600, quality: 'auto:good' });
};

const openFullscreen = (index: number) => {
  fullscreenSlide.value = index;
  fullscreenOpen.value = true;
};

// Pinch-to-zoom (simplified)
let initialDistance = 0;

const onPinchStart = (e: TouchEvent) => {
  if (e.touches.length === 2) {
    initialDistance = getDistance(e.touches[0], e.touches[1]);
  }
};

const onPinchMove = (e: TouchEvent) => {
  if (e.touches.length === 2) {
    const currentDistance = getDistance(e.touches[0], e.touches[1]);
    const scale = currentDistance / initialDistance;
    // Apply zoom transformation
    console.log('Pinch scale:', scale);
  }
};

const getDistance = (touch1: Touch, touch2: Touch) => {
  return Math.hypot(touch2.pageX - touch1.pageX, touch2.pageY - touch1.pageY);
};
</script>

<style lang="scss" scoped>
.thumbnail-item {
  border: 2px solid transparent;
  border-radius: 4px;
  overflow: hidden;
  cursor: pointer;

  &.active {
    border-color: var(--q-primary);
  }
}
</style>
```

### Add Pull-to-Refresh
Create `frontend/src/components/common/PullToRefresh.vue`:

```vue
<template>
  <q-pull-to-refresh @refresh="onRefresh" color="primary">
    <slot />
  </q-pull-to-refresh>
</template>

<script setup lang="ts">
const emit = defineEmits(['refresh']);

const onRefresh = (done: () => void) => {
  emit('refresh');
  setTimeout(done, 1000);
};
</script>
```

### Add Safe Area Handling
Add to `frontend/src/css/app.scss`:

```scss
// Safe area handling for notched devices
.safe-area-top {
  padding-top: env(safe-area-inset-top);
}

.safe-area-bottom {
  padding-bottom: env(safe-area-inset-bottom);
}

// Mobile-specific adjustments
@media (max-width: $breakpoint-sm-max) {
  .q-page {
    padding-bottom: 60px; // Space for bottom nav
  }

  // Larger touch targets
  .q-btn {
    min-height: 44px;
    min-width: 44px;
  }

  .q-field {
    .q-field__control {
      min-height: 48px;
    }
  }

  // Better text readability
  .text-body1 {
    font-size: 16px;
    line-height: 1.5;
  }
}
```

## Acceptance Criteria
- [ ] Mobile navigation works
- [ ] Bottom nav works
- [ ] Touch gestures work
- [ ] Image gallery swipeable
- [ ] Pull-to-refresh works
- [ ] Safe areas respected
- [ ] Touch targets > 44px
- [ ] No horizontal scroll
