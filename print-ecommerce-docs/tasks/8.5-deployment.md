# Task 8.5: Deployment

## Goal
Set up production deployment on Vultr VPS with Docker.

## Instructions

### Create Docker Configuration
Create `docker-compose.yml`:

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: print-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - print-network

  strapi:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: print-strapi
    restart: unless-stopped
    environment:
      DATABASE_CLIENT: postgres
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DB_NAME}
      DATABASE_USERNAME: ${DB_USER}
      DATABASE_PASSWORD: ${DB_PASSWORD}
      DATABASE_SSL: 'false'
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_JWT_SECRET: ${ADMIN_JWT_SECRET}
      APP_KEYS: ${APP_KEYS}
      API_TOKEN_SALT: ${API_TOKEN_SALT}
      TRANSFER_TOKEN_SALT: ${TRANSFER_TOKEN_SALT}
      NODE_ENV: production
    volumes:
      - strapi_uploads:/opt/app/public/uploads
    depends_on:
      - postgres
    networks:
      - print-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_STRAPI_URL: ${STRAPI_URL}
        VITE_SUPABASE_URL: ${SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
        VITE_CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
        VITE_GA_MEASUREMENT_ID: ${GA_MEASUREMENT_ID}
    container_name: print-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      STRAPI_URL: http://strapi:1337
    depends_on:
      - strapi
    networks:
      - print-network

  nginx:
    image: nginx:alpine
    container_name: print-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - certbot_data:/var/www/certbot
    depends_on:
      - frontend
      - strapi
    networks:
      - print-network

  certbot:
    image: certbot/certbot
    container_name: print-certbot
    volumes:
      - certbot_data:/var/www/certbot
      - ./nginx/ssl:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  postgres_data:
  strapi_uploads:
  certbot_data:

networks:
  print-network:
    driver: bridge
```

### Create Strapi Dockerfile
Create `backend/Dockerfile`:

```dockerfile
FROM node:18-alpine AS build

WORKDIR /opt/app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM node:18-alpine

WORKDIR /opt/app

COPY --from=build /opt/app ./

ENV NODE_ENV=production
ENV HOST=0.0.0.0
ENV PORT=1337

EXPOSE 1337

CMD ["npm", "start"]
```

### Create Frontend Dockerfile
Create `frontend/Dockerfile`:

```dockerfile
FROM node:18-alpine AS build

WORKDIR /app

ARG VITE_STRAPI_URL
ARG VITE_SUPABASE_URL
ARG VITE_SUPABASE_ANON_KEY
ARG VITE_CLOUDINARY_CLOUD_NAME
ARG VITE_GA_MEASUREMENT_ID

ENV VITE_STRAPI_URL=$VITE_STRAPI_URL
ENV VITE_SUPABASE_URL=$VITE_SUPABASE_URL
ENV VITE_SUPABASE_ANON_KEY=$VITE_SUPABASE_ANON_KEY
ENV VITE_CLOUDINARY_CLOUD_NAME=$VITE_CLOUDINARY_CLOUD_NAME
ENV VITE_GA_MEASUREMENT_ID=$VITE_GA_MEASUREMENT_ID

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM node:18-alpine

WORKDIR /app

COPY --from=build /app/dist ./dist
COPY --from=build /app/node_modules ./node_modules
COPY package*.json ./

ENV NODE_ENV=production
ENV HOST=0.0.0.0
ENV PORT=3000

EXPOSE 3000

CMD ["node", "dist/ssr/index.js"]
```

### Create Nginx Configuration
Create `nginx/nginx.conf`:

```nginx
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    # Upstream servers
    upstream frontend {
        server frontend:3000;
    }

    upstream strapi {
        server strapi:1337;
    }

    # HTTP to HTTPS redirect
    server {
        listen 80;
        server_name example.com www.example.com;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # Main HTTPS server
    server {
        listen 443 ssl http2;
        server_name example.com www.example.com;

        ssl_certificate /etc/nginx/ssl/live/example.com/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/live/example.com/privkey.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Strapi API
        location /api/ {
            limit_req zone=api burst=20 nodelay;

            proxy_pass http://strapi;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Strapi Admin
        location /admin {
            proxy_pass http://strapi;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Strapi uploads
        location /uploads/ {
            proxy_pass http://strapi;
            proxy_cache_valid 200 7d;
            add_header Cache-Control "public, max-age=604800";
        }

        # Frontend
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Static assets caching
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            proxy_pass http://frontend;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### Create Deployment Script
Create `scripts/deploy.sh`:

```bash
#!/bin/bash

set -e

echo "ðŸš€ Starting deployment..."

# Configuration
SERVER_USER="deploy"
SERVER_HOST="your-server.vultr.com"
PROJECT_DIR="/opt/print-ecommerce"

# Build and push Docker images (if using registry)
# docker-compose build
# docker-compose push

# Deploy to server
ssh $SERVER_USER@$SERVER_HOST << 'EOF'
    cd /opt/print-ecommerce

    # Pull latest code
    git pull origin main

    # Pull latest images and restart
    docker-compose pull
    docker-compose up -d --build

    # Cleanup old images
    docker image prune -f

    # Run migrations if needed
    docker-compose exec -T strapi npm run strapi -- migration:run

    echo "âœ… Deployment complete!"
EOF
```

### Create Server Setup Script
Create `scripts/setup-server.sh`:

```bash
#!/bin/bash

# Run on fresh Vultr VPS (Ubuntu 22.04)

set -e

echo "ðŸ“¦ Installing dependencies..."

# Update system
apt-get update && apt-get upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# Install Docker Compose
apt-get install -y docker-compose-plugin

# Create deploy user
useradd -m -s /bin/bash deploy
usermod -aG docker deploy

# Setup project directory
mkdir -p /opt/print-ecommerce
chown deploy:deploy /opt/print-ecommerce

# Setup firewall
ufw allow OpenSSH
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

# Install certbot for SSL
apt-get install -y certbot

echo "âœ… Server setup complete!"
echo "Next steps:"
echo "1. Clone your repository to /opt/print-ecommerce"
echo "2. Copy .env.production to .env"
echo "3. Run: certbot certonly --webroot -w /var/www/certbot -d yourdomain.com"
echo "4. Run: docker-compose up -d"
```

### Create Environment Template
Create `.env.production.example`:

```bash
# Database
DB_USER=strapi
DB_PASSWORD=your-secure-password
DB_NAME=print_ecommerce

# Strapi
JWT_SECRET=your-jwt-secret
ADMIN_JWT_SECRET=your-admin-jwt-secret
APP_KEYS=key1,key2,key3,key4
API_TOKEN_SALT=your-api-token-salt
TRANSFER_TOKEN_SALT=your-transfer-token-salt

# URLs
SITE_URL=https://yourdomain.com
STRAPI_URL=https://yourdomain.com
FRONTEND_URL=https://yourdomain.com

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=your-anon-key

# Cloudinary
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret

# PayPlus
PAYPLUS_API_URL=https://api.payplus.co.il
PAYPLUS_API_KEY=your-api-key
PAYPLUS_SECRET_KEY=your-secret-key
PAYPLUS_PAGE_UID=your-page-uid

# Resend
RESEND_API_KEY=your-resend-key
RESEND_FROM_EMAIL=orders@yourdomain.com
RESEND_FROM_NAME=Your Store Name

# Analytics
GA_MEASUREMENT_ID=G-XXXXXXXXXX
```

### Create GitHub Actions Workflow
Create `.github/workflows/deploy.yml`:

```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: ./frontend
        run: npm test

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_STRAPI_URL: ${{ secrets.STRAPI_URL }}
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/print-ecommerce
            git pull origin main
            docker-compose pull
            docker-compose up -d --build
            docker image prune -f
```

## Acceptance Criteria
- [ ] Docker builds successfully
- [ ] Containers start correctly
- [ ] SSL configured
- [ ] Nginx proxies correctly
- [ ] Database persists
- [ ] Uploads persist
- [ ] CI/CD works
- [ ] Zero-downtime deploys
