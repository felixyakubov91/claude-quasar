# Task 2.2: Strapi Permissions

## Goal
Configure user roles and permissions for API access.

## Prerequisites
- Task 2.1 completed

## Instructions

### Step 1: Configure Public Role

Go to Settings → Roles → Public

Enable these permissions:

**Category:**
- find, findOne

**Product:**
- find, findOne

**Review:**
- find (for displaying on products)

**Homepage:**
- find

### Step 2: Configure Authenticated Role

Go to Settings → Roles → Authenticated

Enable these permissions:

**Category:**
- find, findOne

**Product:**
- find, findOne

**Order:**
- create, find (own), findOne (own)

**OrderItem:**
- find (own), findOne (own)

**Cart:**
- create, find (own), update (own), delete (own)

**Review:**
- create, find, findOne, update (own), delete (own)

**Customer:**
- findOne (own), update (own)

**UploadedImage:**
- create, find (own), findOne (own), update (own)

### Step 3: Create Admin Role

Go to Settings → Roles → Create new role → "Store Admin"

Enable all permissions for:
- All content types (CRUD)
- Upload (all)
- Users-permissions (all)

### Step 4: Create Custom Policy for Own Data

Create `backend/src/policies/is-owner.js`:

```javascript
module.exports = async (policyContext, config, { strapi }) => {
  const { user } = policyContext.state;
  const { id } = policyContext.params;

  if (!user) return false;

  const entity = await strapi.entityService.findOne(
    policyContext.state.route.info.apiName,
    id,
    { populate: ['customer'] }
  );

  if (!entity) return false;

  // Check if user owns this entity
  return entity.customer?.supabase_id === user.supabase_id;
};
```

### Step 5: Apply Policy to Routes

Update `backend/src/api/order/routes/order.js`:

```javascript
module.exports = {
  routes: [
    {
      method: 'GET',
      path: '/orders',
      handler: 'order.find',
      config: {
        policies: ['is-owner'],
      },
    },
    {
      method: 'GET',
      path: '/orders/:id',
      handler: 'order.findOne',
      config: {
        policies: ['is-owner'],
      },
    },
  ],
};
```

## Acceptance Criteria
- [ ] Public can read products/categories
- [ ] Authenticated can create orders
- [ ] Users can only access their own orders
- [ ] Admins have full access
