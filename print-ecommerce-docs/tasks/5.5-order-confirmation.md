# Task 5.5: Order Confirmation

## Goal
Show order confirmation and send email via Resend.

## Instructions

### Create Confirmation Page
Create `frontend/src/pages/checkout/ConfirmationPage.vue`:

```vue
<template>
  <q-page class="q-pa-md">
    <div class="row justify-center">
      <div class="col-12 col-md-8 text-center">
        <q-icon name="check_circle" color="positive" size="80px" />
        <h1 class="text-h4 q-mt-md">{{ $t('checkout.thankYou') }}</h1>
        <p class="text-h6 text-grey-7">{{ $t('checkout.orderNumber') }}: {{ order?.order_number }}</p>
        
        <q-card class="q-mt-lg text-left">
          <q-card-section>
            <div class="text-h6">{{ $t('checkout.orderDetails') }}</div>
          </q-card-section>
          <q-separator />
          <q-list>
            <q-item v-for="item in order?.items" :key="item.id">
              <q-item-section avatar>
                <q-img :src="item.product?.thumbnail?.url" width="60px" />
              </q-item-section>
              <q-item-section>
                <q-item-label>{{ item.product_snapshot?.name }}</q-item-label>
                <q-item-label caption>{{ $t('products.quantity') }}: {{ item.quantity }}</q-item-label>
              </q-item-section>
              <q-item-section side>
                {{ formatPrice(item.total_price) }}
              </q-item-section>
            </q-item>
          </q-list>
          <q-separator />
          <q-card-section class="text-right">
            <div class="text-h6">{{ $t('cart.total') }}: {{ formatPrice(order?.total) }}</div>
          </q-card-section>
        </q-card>

        <q-btn
          color="primary"
          :label="$t('nav.home')"
          class="q-mt-lg"
          :to="{ name: 'home' }"
        />
      </div>
    </div>
  </q-page>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import { useCartStore } from 'src/stores/cart.store';
import { strapiService } from 'src/services/strapi.service';
import { useAuth } from 'src/composables/useAuth';
import { env } from 'src/utils/env';

const route = useRoute();
const cartStore = useCartStore();
const { session } = useAuth();

const order = ref<any>(null);

const formatPrice = (price: number) => `${env.currencySymbol}${(price || 0).toFixed(2)}`;

onMounted(async () => {
  const orderId = route.query.order as string;
  if (orderId) {
    const response = await strapiService.getOrder(orderId, session.value?.access_token);
    order.value = response.data?.attributes;
    
    // Clear cart after successful order
    cartStore.clearCart();
    sessionStorage.removeItem('checkoutData');
  }
});
</script>
```

### Create Resend Email Service in Strapi
Create `backend/src/services/email.js`:

```javascript
const { Resend } = require('resend');

const resend = new Resend(process.env.RESEND_API_KEY);

module.exports = {
  async sendOrderConfirmation(order) {
    await resend.emails.send({
      from: `${process.env.RESEND_FROM_NAME} <${process.env.RESEND_FROM_EMAIL}>`,
      to: order.customer.email,
      subject: `Order Confirmation - ${order.order_number}`,
      html: `
        <h1>Thank you for your order!</h1>
        <p>Order Number: <strong>${order.order_number}</strong></p>
        <p>Total: â‚ª${order.total.toFixed(2)}</p>
        <p>We'll notify you when your order ships.</p>
      `,
    });
  },
};
```

### Add Email to Order Lifecycle
Update order lifecycle to send email on payment:

```javascript
const email = require('../../../services/email');

module.exports = {
  async afterUpdate(event) {
    const { result } = event;
    
    if (result.payment_status === 'paid') {
      const order = await strapi.entityService.findOne('api::order.order', result.id, {
        populate: ['customer', 'items.product'],
      });
      await email.sendOrderConfirmation(order);
    }
  },
};
```

## Acceptance Criteria
- [ ] Confirmation page shows order details
- [ ] Cart clears after order
- [ ] Email sends on successful payment
