# Task 8.1: Strapi Admin Customization

## Goal
Customize Strapi admin for better order management and image downloads.

## Instructions

### Create Custom Admin Dashboard Widget
Create `backend/src/admin/widgets/orders-widget.js`:

```javascript
// This is configured in Strapi admin through plugin development
// For a quick solution, use the existing dashboard customization

// backend/src/admin/app.js
export default {
  config: {
    locales: ['en', 'he'],
    notifications: { releases: false },
    tutorials: false,
  },
  bootstrap(app) {
    console.log('Admin app bootstrap');
  },
};
```

### Create Order Image Download Controller
Create `backend/src/api/order/controllers/download.js`:

```javascript
'use strict';

const archiver = require('archiver');
const axios = require('axios');
const { PassThrough } = require('stream');

module.exports = {
  async downloadImages(ctx) {
    const { id } = ctx.params;

    // Get order with images
    const order = await strapi.entityService.findOne('api::order.order', id, {
      populate: {
        items: {
          populate: {
            uploaded_images: true,
          },
        },
      },
    });

    if (!order) {
      return ctx.notFound('Order not found');
    }

    const images = [];
    for (const item of order.items) {
      if (item.uploaded_images) {
        for (const img of item.uploaded_images) {
          images.push({
            url: img.cloudinary_url || img.print_ready_url,
            filename: `item-${item.id}-${img.original_filename || img.id}.${img.format || 'jpg'}`,
          });
        }
      }
    }

    if (images.length === 0) {
      return ctx.badRequest('No images to download');
    }

    // Create ZIP archive
    const archive = archiver('zip', { zlib: { level: 9 } });
    const passThrough = new PassThrough();

    ctx.set('Content-Type', 'application/zip');
    ctx.set('Content-Disposition', `attachment; filename="order-${order.order_number}-images.zip"`);

    archive.pipe(passThrough);

    // Add images to archive
    for (const image of images) {
      try {
        const response = await axios.get(image.url, { responseType: 'arraybuffer' });
        archive.append(Buffer.from(response.data), { name: image.filename });
      } catch (error) {
        console.error(`Failed to download image: ${image.url}`, error);
      }
    }

    archive.finalize();

    // Update download tracking
    await strapi.entityService.update('api::order.order', id, {
      data: {
        images_downloaded_at: new Date(),
        images_download_count: (order.images_download_count || 0) + 1,
      },
    });

    ctx.body = passThrough;
  },

  async markImagesDownloaded(ctx) {
    const { id } = ctx.params;

    const order = await strapi.entityService.update('api::order.order', id, {
      data: {
        images_downloaded_at: new Date(),
      },
      populate: ['items.uploaded_images'],
    });

    // Update each uploaded image
    for (const item of order.items) {
      if (item.uploaded_images) {
        for (const img of item.uploaded_images) {
          await strapi.entityService.update('api::uploaded-image.uploaded-image', img.id, {
            data: {
              download_count: (img.download_count || 0) + 1,
              last_downloaded_at: new Date(),
            },
          });
        }
      }
    }

    return { success: true, downloadedAt: order.images_downloaded_at };
  },
};
```

### Add Custom Routes
Update `backend/src/api/order/routes/custom.js`:

```javascript
module.exports = {
  routes: [
    {
      method: 'GET',
      path: '/orders/:id/download-images',
      handler: 'download.downloadImages',
      config: {
        policies: [],
        middlewares: [],
      },
    },
    {
      method: 'POST',
      path: '/orders/:id/mark-downloaded',
      handler: 'download.markImagesDownloaded',
      config: {
        policies: [],
        middlewares: [],
      },
    },
  ],
};
```

### Create Order Status Update Service
Create `backend/src/api/order/services/order-status.js`:

```javascript
'use strict';

const emailService = require('../../../services/email');

module.exports = {
  async updateStatus(orderId, newStatus, options = {}) {
    const order = await strapi.entityService.findOne('api::order.order', orderId, {
      populate: ['customer', 'items.product'],
    });

    if (!order) {
      throw new Error('Order not found');
    }

    const updateData = {
      status: newStatus,
    };

    // Add timestamp based on status
    switch (newStatus) {
      case 'shipped':
        updateData.shipped_at = new Date();
        if (options.trackingNumber) {
          updateData.tracking_number = options.trackingNumber;
        }
        break;
      case 'delivered':
        updateData.delivered_at = new Date();
        break;
    }

    const updatedOrder = await strapi.entityService.update('api::order.order', orderId, {
      data: updateData,
    });

    // Send notification email
    await this.sendStatusNotification(order, newStatus, options);

    return updatedOrder;
  },

  async sendStatusNotification(order, status, options = {}) {
    const customer = order.customer;
    if (!customer?.email) return;

    const templates = {
      confirmed: {
        subject: `Order ${order.order_number} Confirmed`,
        template: 'order-confirmed',
      },
      processing: {
        subject: `Order ${order.order_number} is Being Processed`,
        template: 'order-processing',
      },
      printing: {
        subject: `Order ${order.order_number} is Being Printed`,
        template: 'order-printing',
      },
      shipped: {
        subject: `Order ${order.order_number} Has Shipped`,
        template: 'order-shipped',
      },
      delivered: {
        subject: `Order ${order.order_number} Delivered`,
        template: 'order-delivered',
      },
    };

    const config = templates[status];
    if (!config) return;

    await emailService.sendOrderStatusEmail(customer.email, {
      orderNumber: order.order_number,
      status,
      trackingNumber: options.trackingNumber,
      customerName: customer.full_name,
    });
  },
};
```

### Create Bulk Actions for Orders
Create `backend/src/api/order/controllers/bulk.js`:

```javascript
'use strict';

module.exports = {
  async bulkUpdateStatus(ctx) {
    const { orderIds, status, trackingNumbers } = ctx.request.body;

    if (!orderIds || !Array.isArray(orderIds) || !status) {
      return ctx.badRequest('Invalid request');
    }

    const results = [];

    for (let i = 0; i < orderIds.length; i++) {
      const orderId = orderIds[i];
      const trackingNumber = trackingNumbers?.[i];

      try {
        const order = await strapi.service('api::order.order-status').updateStatus(
          orderId,
          status,
          { trackingNumber }
        );
        results.push({ id: orderId, success: true, order });
      } catch (error) {
        results.push({ id: orderId, success: false, error: error.message });
      }
    }

    return { results };
  },

  async exportOrders(ctx) {
    const { filters, format = 'csv' } = ctx.query;

    const orders = await strapi.entityService.findMany('api::order.order', {
      filters: filters ? JSON.parse(filters) : {},
      populate: ['customer', 'items.product', 'coupon'],
      sort: { createdAt: 'desc' },
    });

    if (format === 'csv') {
      const csv = generateOrdersCsv(orders);
      ctx.set('Content-Type', 'text/csv');
      ctx.set('Content-Disposition', 'attachment; filename="orders.csv"');
      return csv;
    }

    return orders;
  },
};

function generateOrdersCsv(orders) {
  const headers = [
    'Order Number',
    'Date',
    'Customer',
    'Email',
    'Status',
    'Payment Status',
    'Subtotal',
    'Shipping',
    'Discount',
    'Total',
    'Items',
  ];

  const rows = orders.map(order => [
    order.order_number,
    new Date(order.createdAt).toLocaleDateString(),
    order.customer?.full_name || '',
    order.customer?.email || '',
    order.status,
    order.payment_status,
    order.subtotal,
    order.shipping_cost,
    order.discount_amount || 0,
    order.total,
    order.items?.length || 0,
  ]);

  return [headers, ...rows].map(row => row.join(',')).join('\n');
}
```

### Add Bulk Routes
Update `backend/src/api/order/routes/custom.js`:

```javascript
module.exports = {
  routes: [
    // ... existing routes ...
    {
      method: 'POST',
      path: '/orders/bulk-update-status',
      handler: 'bulk.bulkUpdateStatus',
      config: {
        policies: [],
        middlewares: [],
      },
    },
    {
      method: 'GET',
      path: '/orders/export',
      handler: 'bulk.exportOrders',
      config: {
        policies: [],
        middlewares: [],
      },
    },
  ],
};
```

### Install Required Dependencies
```bash
cd backend
npm install archiver
```

## Acceptance Criteria
- [ ] Image download ZIP works
- [ ] Download tracking updates
- [ ] Status updates send emails
- [ ] Bulk status update works
- [ ] CSV export works
