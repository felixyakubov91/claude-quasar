# Task 5.2: Coupon System

## Goal
Implement coupon validation and application.

## Instructions

### Create Coupon Composable
Create `frontend/src/composables/useCoupons.ts`:

```typescript
import { ref } from 'vue';
import { strapiService } from 'src/services/strapi.service';
import { useCartStore } from 'src/stores/cart.store';

export function useCoupons() {
  const cartStore = useCartStore();
  const appliedCoupon = ref<any>(null);
  const couponError = ref<string | null>(null);
  const loading = ref(false);

  const applyCoupon = async (code: string) => {
    loading.value = true;
    couponError.value = null;

    try {
      const coupon = await strapiService.validateCoupon(code);

      if (!coupon) {
        couponError.value = 'coupon.invalid';
        return false;
      }

      if (coupon.attributes.minimum_order > cartStore.subtotal) {
        couponError.value = 'coupon.minimumNotMet';
        return false;
      }

      if (coupon.attributes.usage_count >= coupon.attributes.usage_limit) {
        couponError.value = 'coupon.limitReached';
        return false;
      }

      appliedCoupon.value = coupon;
      return true;
    } catch (error) {
      couponError.value = 'coupon.error';
      return false;
    } finally {
      loading.value = false;
    }
  };

  const removeCoupon = () => {
    appliedCoupon.value = null;
    couponError.value = null;
  };

  const calculateDiscount = () => {
    if (!appliedCoupon.value) return 0;

    const { discount_type, discount_value, maximum_discount } = appliedCoupon.value.attributes;

    let discount = 0;
    switch (discount_type) {
      case 'percentage':
        discount = cartStore.subtotal * (discount_value / 100);
        if (maximum_discount) discount = Math.min(discount, maximum_discount);
        break;
      case 'fixed':
        discount = discount_value;
        break;
    }

    return discount;
  };

  return {
    appliedCoupon,
    couponError,
    loading,
    applyCoupon,
    removeCoupon,
    calculateDiscount,
  };
}
```

### Create CouponInput Component
Create `frontend/src/components/cart/CouponInput.vue`:

```vue
<template>
  <div class="coupon-input">
    <div v-if="appliedCoupon" class="row items-center q-pa-sm bg-positive-light rounded-borders">
      <q-icon name="check_circle" color="positive" class="q-mr-sm" />
      <span class="text-positive">{{ appliedCoupon.attributes.code }}</span>
      <span class="q-mx-sm">-{{ formatDiscount }}</span>
      <q-space />
      <q-btn flat dense icon="close" size="sm" @click="removeCoupon" />
    </div>

    <div v-else class="row q-col-gutter-sm">
      <div class="col">
        <q-input
          v-model="code"
          :label="$t('cart.couponCode')"
          dense
          outlined
          :error="!!couponError"
          :error-message="couponError ? $t(couponError) : ''"
        />
      </div>
      <div class="col-auto">
        <q-btn
          :label="$t('cart.apply')"
          color="primary"
          :loading="loading"
          @click="handleApply"
        />
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { useCoupons } from 'src/composables/useCoupons';
import { env } from 'src/utils/env';

const { appliedCoupon, couponError, loading, applyCoupon, removeCoupon, calculateDiscount } = useCoupons();

const code = ref('');

const formatDiscount = computed(() => {
  const discount = calculateDiscount();
  return `${env.currencySymbol}${discount.toFixed(2)}`;
});

const handleApply = async () => {
  await applyCoupon(code.value.toUpperCase());
};
</script>
```

## Acceptance Criteria
- [ ] Coupon validation works
- [ ] Discount calculates correctly
- [ ] Error messages show
- [ ] Coupon can be removed
